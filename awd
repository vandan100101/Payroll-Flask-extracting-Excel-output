# ============================================================================
# FLASK PAYROLL PROCESSING APPLICATION
# Modern web-based replacement for VBA Excel payroll system
# ============================================================================

from flask import Flask, render_template, request, jsonify, send_file
import pandas as pd
import openpyxl
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from datetime import datetime
import os
from werkzeug.utils import secure_filename
import traceback

app = Flask(__name__)
app.config['UPLOAD_FOLDER'] = 'uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16MB max file size
app.config['ALLOWED_EXTENSIONS'] = {'xlsx', 'xls', 'xlsb', 'txt'}

# Ensure upload folder exists
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

# ============================================================================
# CONFIGURATION & CONSTANTS
# ============================================================================

COMPANY_NAME = "Leader Electronics (Philippine Branch) Incorporated"
MIN_WAGE = "Minimum Wage      P520.00/day"
YEAR = 2025

# Month configurations
MONTH_CONFIG = {
    'January': {'code': '01', 'prev': 'December', 'days': 31},
    'February': {'code': '02', 'prev': 'January', 'days': 28},
    'March': {'code': '03', 'prev': 'February', 'days': 31},
    'April': {'code': '04', 'prev': 'March', 'days': 30},
    'May': {'code': '05', 'prev': 'April', 'days': 31},
    'June': {'code': '06', 'prev': 'May', 'days': 30},
    'July': {'code': '07', 'prev': 'June', 'days': 31},
    'August': {'code': '08', 'prev': 'July', 'days': 31},
    'September': {'code': '09', 'prev': 'August', 'days': 30},
    'October': {'code': '10', 'prev': 'September', 'days': 31},
    'November': {'code': '11', 'prev': 'October', 'days': 30},
    'December': {'code': '12', 'prev': 'November', 'days': 31}
}

# Department color codes (hex)
DEPT_COLORS = {
    'IND_PROD': 'CDFFCF',        # Light Green
    'IND_QA': 'D1FFFF',          # Light Cyan
    'IND_QA_ALT': 'FFFFD5',      # Light Yellow
    'IND_WAREHOUSE': 'FFEBFF',   # Light Pink
    'IND_702': 'CCFFFF',         # Light Blue
    'DIRECT_PROD': 'FFF1DD',     # Light Orange
    'IND_1002': 'CCCCFF',        # Light Purple
    'GRAND_TOTAL': 'FABF8F'      # Peach
}

# Department mappings
DEPT_TOTALS = {
    1: 'TOTAL IND2001',
    2: 'TOTAL IND2005',
    3: 'TOTAL IND2101',
    4: 'TOTAL IND2102',
    5: 'TOTAL IND202',
    6: 'TOTAL IND202-1',
    7: 'TOTAL IND203',
    8: 'TOTAL IND203-1',
    9: 'TOTAL IND204',
    10: 'TOTAL IND205',
    11: 'TOTAL IND503',
    12: 'TOTAL IND506',
    13: 'TOTAL IND702',
    14: 'TOTAL D2001',
    15: 'TOTAL D2005',
    16: 'TOTAL IND1002'
}

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

def allowed_file(filename):
    """Check if file extension is allowed"""
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in app.config['ALLOWED_EXTENSIONS']

def safe_int(value, default=0):
    """Safely convert to integer"""
    try:
        return int(float(value)) if pd.notna(value) else default
    except (ValueError, TypeError):
        return default

def safe_float(value, default=0.0):
    """Safely convert to float"""
    try:
        return float(value) if pd.notna(value) else default
    except (ValueError, TypeError):
        return default

# ============================================================================
# PAYROLL PROCESSING CLASS
# ============================================================================

class PayrollProcessor:
    def __init__(self, dataframe, dbase_df, month, cutoff):
        self.df = dataframe
        self.dbase = dbase_df
        self.month = month
        self.cutoff = cutoff
        self.month_info = MONTH_CONFIG[month]
        
    def add_lookups(self):
        """Add CCR code and account number lookups"""
        try:
            # Add CCR CODE lookup (column 6 from dbase)
            self.df['CCR_CODE'] = self.df.iloc[:, 0].map(
                self.dbase.set_index(self.dbase.columns[0])[self.dbase.columns[5]]
            ).fillna('Not in dbase')
            
            # Add Account Number lookup (column 4 from dbase)
            self.df['ACCT_NO'] = self.df.iloc[:, 0].map(
                self.dbase.set_index(self.dbase.columns[0])[self.dbase.columns[3]]
            ).fillna('Not in dbase')
            
            # Reorder columns to put lookups at front
            cols = ['CCR_CODE', self.df.columns[0], 'ACCT_NO'] + \
                   [col for col in self.df.columns if col not in ['CCR_CODE', 'ACCT_NO', self.df.columns[0]]]
            self.df = self.df[cols]
            
        except Exception as e:
            print(f"Error in add_lookups: {e}")
            raise
    
    def sort_data(self):
        """Sort by CCR code, then by employee ID"""
        try:
            self.df = self.df.sort_values(
                by=[self.df.columns[0], self.df.columns[1], self.df.columns[3]],
                na_position='last'
            )
            self.df.reset_index(drop=True, inplace=True)
        except Exception as e:
            print(f"Error in sort_data: {e}")
            raise
    
    def add_13th_month(self):
        """Add 13th month pay calculation"""
        try:
            # Assuming column 8 is basic salary
            if len(self.df.columns) > 7:
                self.df['13TH_MONTH'] = self.df.iloc[:, 7].apply(
                    lambda x: safe_float(x) / 12.0
                )
        except Exception as e:
            print(f"Error in add_13th_month: {e}")
            raise
    
    def insert_subtotals(self):
        """Insert subtotal rows by department"""
        try:
            # Group by CCR code
            grouped = self.df.groupby(self.df.columns[0], dropna=False)
            
            result_dfs = []
            dept_counter = 1
            
            # Track accumulated totals for group summaries
            ind_prod_groups = []
            ind_qa_groups = []
            ind_warehouse_groups = []
            direct_prod_groups = []
            
            # Track all employee data rows for grand total
            all_employee_rows = []
            
            for name, group in grouped:
                if pd.isna(name):
                    continue
                
                # Store employee data rows (not subtotals)
                all_employee_rows.append(group)
                    
                # Add the group data
                result_dfs.append(group)
                
                # Create subtotal row
                subtotal_row = pd.Series([''] * len(self.df.columns), index=self.df.columns)
                subtotal_label = DEPT_TOTALS.get(dept_counter, f'TOTAL {name}')
                subtotal_row[self.df.columns[2]] = subtotal_label
                subtotal_row[self.df.columns[1]] = len(group)  # Count
                
                # Sum numeric columns
                for col in self.df.columns[7:]:
                    if self.df[col].dtype in ['int64', 'float64']:
                        subtotal_row[col] = group[col].sum()
                
                result_dfs.append(pd.DataFrame([subtotal_row]))
                
                # Track for group totals
                if dept_counter in [1, 2]:
                    ind_prod_groups.append(subtotal_row)
                elif dept_counter in [3, 4, 5, 6, 7, 8, 9, 10]:
                    ind_qa_groups.append(subtotal_row)
                elif dept_counter in [11, 12]:
                    ind_warehouse_groups.append(subtotal_row)
                elif dept_counter in [14, 15]:
                    direct_prod_groups.append(subtotal_row)
                
                # Add special group totals
                if dept_counter == 2:  # After IND2005
                    group_total = self._create_group_total(ind_prod_groups, 'IND PROD TOTAL')
                    result_dfs.append(pd.DataFrame([group_total]))
                    
                elif dept_counter == 10:  # After IND205
                    group_total = self._create_group_total(ind_qa_groups, 'IND QA TOTAL')
                    result_dfs.append(pd.DataFrame([group_total]))
                    
                elif dept_counter == 12:  # After IND506
                    group_total = self._create_group_total(ind_warehouse_groups, 'IND WAREHOUSE TOTAL')
                    result_dfs.append(pd.DataFrame([group_total]))
                    
                elif dept_counter == 15:  # After D2005
                    group_total = self._create_group_total(direct_prod_groups, 'DIRECT PROD TOTAL')
                    result_dfs.append(pd.DataFrame([group_total]))
                
                dept_counter += 1
            
            # Combine all dataframes
            self.df = pd.concat(result_dfs, ignore_index=True)
            
            # Add GRAND TOTAL DAILY row - sum ONLY employee data, not subtotals
            grand_total_row = pd.Series([''] * len(self.df.columns), index=self.df.columns)
            grand_total_row[self.df.columns[2]] = 'GRAND TOTAL DAILY'
            
            # Combine all employee data
            all_employees_df = pd.concat(all_employee_rows, ignore_index=True)
            
            # Sum employee counts and numeric columns from employee rows only
            grand_total_row[self.df.columns[1]] = len(all_employees_df)  # Total employee count
            
            for col in self.df.columns[7:]:
                if self.df[col].dtype in ['int64', 'float64']:
                    # Sum from employee data only, not from subtotal rows
                    col_sum = all_employees_df[col].sum()
                    grand_total_row[col] = col_sum
            
            self.df = pd.concat([self.df, pd.DataFrame([grand_total_row])], ignore_index=True)
            
            # Log grand total for verification
            print(f"\n=== Grand Total Verification ===")
            print(f"Total Employees: {len(all_employees_df)}")
            if len(self.df.columns) > 33:  # If Net Pay column exists
                net_pay_total = grand_total_row[self.df.columns[33]] if len(self.df.columns) > 33 else 0
                print(f"Total Net Pay: â‚±{net_pay_total:,.2f}")
            
        except Exception as e:
            print(f"Error in insert_subtotals: {e}")
            traceback.print_exc()
            raise
    
    def _create_group_total(self, group_rows, label):
        """Helper to create group total rows"""
        if not group_rows:
            return pd.Series([''] * len(self.df.columns), index=self.df.columns)
        
        total_row = pd.Series([''] * len(self.df.columns), index=self.df.columns)
        total_row[self.df.columns[2]] = label
        
        # Sum all numeric columns from subtotal rows
        for col in self.df.columns[1:]:
            if col in group_rows[0].index:
                col_sum = sum(row[col] for row in group_rows if pd.notna(row[col]) and isinstance(row[col], (int, float)))
                if col_sum != 0:
                    total_row[col] = col_sum
        
        return total_row
    
    def process(self):
        """Run complete processing pipeline"""
        try:
            self.add_lookups()
            self.sort_data()
            self.add_13th_month()
            self.insert_subtotals()
            return self.df
        except Exception as e:
            print(f"Error in process: {e}")
            raise

# ============================================================================
# BDO CONVERTER
# ============================================================================

class BDOConverter:
    def __init__(self, paste_df, dbase_df):
        self.paste_df = paste_df
        self.dbase = dbase_df
        
    def convert(self):
        """Convert payroll data to BDO format"""
        try:
            print(f"\n=== BDO Converter Debug Info ===")
            print(f"Payroll DataFrame shape: {self.paste_df.shape}")
            print(f"Database DataFrame shape: {self.dbase.shape}")
            
            # Show first few data values
            print(f"\nFirst few data values:")
            for idx in range(min(3, len(self.paste_df))):
                row_sample = []
                for col_idx in [0, 1, 2, 3, 4, 33, 34]:
                    if col_idx < len(self.paste_df.columns):
                        val = self.paste_df.iloc[idx, col_idx]
                        row_sample.append(f"Col{col_idx}={val}")
                print(f"Row {idx}: {', '.join(row_sample)}")
            
            bank_data = []
            cash_data = []
            
            # Find Net Pay column
            net_pay_col = None
            
            for try_col in [33, 34, 35, 32, 31]:
                if try_col < len(self.paste_df.columns):
                    col_data = self.paste_df.iloc[:, try_col]
                    numeric_data = pd.to_numeric(col_data, errors='coerce')
                    non_zero_values = numeric_data[numeric_data > 0]
                    
                    if len(non_zero_values) > 0:
                        avg_val = non_zero_values.mean()
                        if 1000 < avg_val < 200000:
                            net_pay_col = try_col
                            col_letter = openpyxl.utils.get_column_letter(try_col + 1)
                            print(f"\nFound Net Pay at column {try_col} ({col_letter}) - avg: â‚±{avg_val:,.2f}")
                            break
            
            if net_pay_col is None:
                print(f"\nSearching all columns for Net Pay...")
                for col_idx in range(len(self.paste_df.columns) - 1, max(0, len(self.paste_df.columns) - 20), -1):
                    col_data = self.paste_df.iloc[:, col_idx]
                    numeric_data = pd.to_numeric(col_data, errors='coerce')
                    non_zero_values = numeric_data[numeric_data > 0]
                    
                    if len(non_zero_values) > 10:
                        avg_val = non_zero_values.mean()
                        if 1000 < avg_val < 200000:
                            net_pay_col = col_idx
                            col_letter = openpyxl.utils.get_column_letter(col_idx + 1)
                            print(f"Found Net Pay at column {col_idx} ({col_letter}) - avg: â‚±{avg_val:,.2f}")
                            break
            
            if net_pay_col is None:
                print(f"\nColumn data types:")
                for idx in range(max(0, len(self.paste_df.columns) - 10), len(self.paste_df.columns)):
                    col_letter = openpyxl.utils.get_column_letter(idx + 1)
                    print(f"  Col {idx} ({col_letter}): {self.paste_df.iloc[:, idx].dtype}")
                raise ValueError(f"Could not find Net Pay column. Checked columns 31-35 (AF-AJ). File has {len(self.paste_df.columns)} columns.")
            
            print(f"\nUsing database column 3 for Account Numbers")
            
            # Create lookups from database
            account_lookup = {}
            name_lookup = {}
            
            for idx, row in self.dbase.iterrows():
                emp_id = str(row.iloc[0]).strip()
                
                if pd.notna(row.iloc[0]) and emp_id != 'nan' and emp_id.isdigit():
                    # Account number
                    if pd.notna(row.iloc[3]):
                        acct_val = row.iloc[3]
                        if isinstance(acct_val, float):
                            account_no = str(int(acct_val))
                        else:
                            account_no = str(acct_val).split('.')[0]
                        account_lookup[emp_id] = account_no
                    
                    # Employee name
                    if pd.notna(row.iloc[1]):
                        name_lookup[emp_id] = str(row.iloc[1]).strip()
            
            print(f"\nCreated lookups with {len(account_lookup)} accounts")
            print(f"Sample: {list(account_lookup.items())[:3]}")
            
            # Process payroll rows
            skipped_rows = 0
            bank_count = 0
            cash_count = 0
            skipped_details = {'no_emp_id': 0, 'zero_pay': 0, 'keyword': 0}
            
            for idx, row in self.paste_df.iterrows():
                try:
                    # Find employee ID
                    emp_id = None
                    for col_idx in [0, 1, 2]:
                        if col_idx < len(row):
                            val = str(row.iloc[col_idx]).strip()
                            if val.isdigit() and len(val) == 6:
                                emp_id = val
                                break
                    
                    if not emp_id:
                        skipped_rows += 1
                        skipped_details['no_emp_id'] += 1
                        continue
                    
                    # Skip keywords
                    if not emp_id.isdigit():
                        if any(kw in emp_id.upper() for kw in ['TOTAL', 'GRAND', 'CCR', 'ACCT']):
                            skipped_rows += 1
                            skipped_details['keyword'] += 1
                            continue
                    
                    # Get net pay
                    net_pay = safe_float(row.iloc[net_pay_col])
                    
                    if net_pay <= 0:
                        skipped_rows += 1
                        skipped_details['zero_pay'] += 1
                        if bank_count + cash_count < 5:
                            print(f"  Skipping {emp_id}: Net Pay = {net_pay}")
                        continue
                    
                    # Look up account and name
                    account_no = account_lookup.get(emp_id)
                    employee_name = name_lookup.get(emp_id, f"Employee {emp_id}")
                    
                    # Separate into bank or cash based on account availability
                    if account_no:
                        # HAS BANK ACCOUNT
                        account_with_prefix = f"00{account_no}"
                        
                        bank_data.append({
                            'Account No.': account_with_prefix,
                            'Net Pay': net_pay,
                            'Name': employee_name,
                            'Emp ID': emp_id
                        })
                        
                        bank_count += 1
                        
                        if bank_count <= 3:
                            print(f"âœ“ BANK: {emp_id} -> {account_with_prefix}, {employee_name}, â‚±{net_pay:,.2f}")
                    else:
                        # NO BANK ACCOUNT - CASH PAYROLL
                        cash_data.append({
                            'Emp ID': emp_id,
                            'Net Pay': net_pay,
                            'Name': employee_name
                        })
                        
                        cash_count += 1
                        
                        if cash_count <= 3:
                            print(f"ðŸ’µ CASH: {emp_id} -> {employee_name}, â‚±{net_pay:,.2f}")
                    
                except Exception as row_error:
                    print(f"  Error on row {idx}: {row_error}")
                    skipped_rows += 1
                    continue
            
            print(f"\n=== Summary ===")
            print(f"Total rows in file: {len(self.paste_df)}")
            print(f"BDO Bank Payroll: {bank_count}")
            print(f"Cash Payroll: {cash_count}")
            print(f"Skipped rows: {skipped_rows}")
            print(f"  - No employee ID: {skipped_details['no_emp_id']}")
            print(f"  - Zero/negative pay: {skipped_details['zero_pay']}")
            print(f"  - Keyword rows: {skipped_details['keyword']}")
            
            if not bank_data and not cash_data:
                raise ValueError(
                    f"No valid data found. Checked {len(self.paste_df)} rows.\n"
                    f"Please ensure:\n"
                    f"1. Employee IDs (6 digits) are in first columns\n"
                    f"2. Net Pay column has positive values\n"
                    f"3. Employee IDs match database file"
                )
            
            # Create dataframes
            bank_df = pd.DataFrame(bank_data) if bank_data else pd.DataFrame(columns=['Account No.', 'Net Pay', 'Name'])
            cash_df = pd.DataFrame(cash_data) if cash_data else pd.DataFrame(columns=['Emp ID', 'Net Pay', 'Name'])
            
            # Calculate totals
            bank_total = bank_df['Net Pay'].sum() if len(bank_df) > 0 else 0
            cash_total = cash_df['Net Pay'].sum() if len(cash_df) > 0 else 0
            total_payroll = bank_total + cash_total
            
            print(f"\nðŸ’° BDO Bank Total: â‚±{bank_total:,.2f}")
            print(f"ðŸ’µ Cash Total: â‚±{cash_total:,.2f}")
            print(f"ðŸ“Š Total Payroll: â‚±{total_payroll:,.2f}")
            
            # Remove Emp ID column from bank data
            if len(bank_df) > 0:
                bank_df = bank_df[['Account No.', 'Net Pay', 'Name']]
                bank_df = bank_df.sort_values('Name').reset_index(drop=True)
            
            if len(cash_df) > 0:
                cash_df = cash_df.sort_values('Name').reset_index(drop=True)
            
            return {
                'bank': bank_df,
                'cash': cash_df,
                'bank_total': bank_total,
                'cash_total': cash_total,
                'total': total_payroll,
                'bank_count': bank_count,
                'cash_count': cash_count
            }
            
        except Exception as e:
            print(f"Error: {e}")
            traceback.print_exc()
            raise
        """Convert payroll data to BDO format"""
        try:
            print(f"\n=== BDO Converter Debug Info ===")
            print(f"Payroll DataFrame shape: {self.paste_df.shape}")
            print(f"Database DataFrame shape: {self.dbase.shape}")
            
            # Show first non-empty row
            print(f"\nFirst few data values:")
            for idx in range(min(3, len(self.paste_df))):
                row_sample = []
                for col_idx in [0, 1, 2, 3, 4, 33, 34]:  # Show key columns including AH (33)
                    if col_idx < len(self.paste_df.columns):
                        val = self.paste_df.iloc[idx, col_idx]
                        row_sample.append(f"Col{col_idx}={val}")
                print(f"Row {idx}: {', '.join(row_sample)}")
            
            result_data = []
            
            # Find Net Pay column - column AH (index 33) or nearby
            net_pay_col = None
            
            # First, try column 33 (AH) and 34 (AI)
            for try_col in [33, 34, 35, 32, 31]:
                if try_col < len(self.paste_df.columns):
                    col_data = self.paste_df.iloc[:, try_col]
                    # Check if column has numeric data
                    numeric_data = pd.to_numeric(col_data, errors='coerce')
                    non_zero_values = numeric_data[numeric_data > 0]
                    
                    if len(non_zero_values) > 0:
                        avg_val = non_zero_values.mean()
                        # Typical net pay range: 1,000 to 200,000
                        if 1000 < avg_val < 200000:
                            net_pay_col = try_col
                            col_letter = openpyxl.utils.get_column_letter(try_col + 1)  # +1 for Excel column
                            print(f"\nFound Net Pay at column {try_col} ({col_letter}) - avg: â‚±{avg_val:,.2f}")
                            break
            
            # If not found in expected columns, search all columns
            if net_pay_col is None:
                print(f"\nSearching all columns for Net Pay...")
                for col_idx in range(len(self.paste_df.columns) - 1, max(0, len(self.paste_df.columns) - 20), -1):
                    col_data = self.paste_df.iloc[:, col_idx]
                    numeric_data = pd.to_numeric(col_data, errors='coerce')
                    non_zero_values = numeric_data[numeric_data > 0]
                    
                    if len(non_zero_values) > 10:  # At least 10 employees
                        avg_val = non_zero_values.mean()
                        if 1000 < avg_val < 200000:
                            net_pay_col = col_idx
                            col_letter = openpyxl.utils.get_column_letter(col_idx + 1)
                            print(f"Found Net Pay at column {col_idx} ({col_letter}) - avg: â‚±{avg_val:,.2f}")
                            break
            
            if net_pay_col is None:
                # Show column data types to help debug
                print(f"\nColumn data types:")
                for idx in range(max(0, len(self.paste_df.columns) - 10), len(self.paste_df.columns)):
                    col_letter = openpyxl.utils.get_column_letter(idx + 1)
                    print(f"  Col {idx} ({col_letter}): {self.paste_df.iloc[:, idx].dtype}")
                raise ValueError(f"Could not find Net Pay column. Checked columns 31-35 (AF-AJ). File has {len(self.paste_df.columns)} columns.")
            
            # Database: Find employee ID column (column 0) and account number column
            # From your data: Column 0 = Emp ID, Column 3 = Account No
            acct_col = 3
            print(f"\nUsing database column {acct_col} for Account Numbers")
            
            # Create account lookup from database
            account_lookup = {}
            name_lookup = {}
            
            for idx, row in self.dbase.iterrows():
                emp_id = str(row.iloc[0]).strip()
                
                # Clean employee ID
                if pd.notna(row.iloc[0]) and emp_id != 'nan' and emp_id.isdigit():
                    # Account number
                    if pd.notna(row.iloc[acct_col]):
                        acct_val = row.iloc[acct_col]
                        # Handle scientific notation
                        if isinstance(acct_val, float):
                            account_no = str(int(acct_val))
                        else:
                            account_no = str(acct_val).split('.')[0]
                        
                        account_lookup[emp_id] = account_no
                    
                    # Employee name (column 1 in database)
                    if pd.notna(row.iloc[1]):
                        name_lookup[emp_id] = str(row.iloc[1]).strip()
            
            print(f"\nCreated lookups with {len(account_lookup)} accounts")
            print(f"Sample: {list(account_lookup.items())[:3]}")
            
            # Process payroll rows
            skipped_rows = 0
            processed_rows = 0
            skipped_details = {'no_emp_id': 0, 'no_account': 0, 'zero_pay': 0, 'keyword': 0}
            
            for idx, row in self.paste_df.iterrows():
                try:
                    # Find employee ID - check first few columns
                    emp_id = None
                    for col_idx in [0, 1, 2]:
                        if col_idx < len(row):
                            val = str(row.iloc[col_idx]).strip()
                            # Check if it looks like an employee ID (6-digit number)
                            if val.isdigit() and len(val) == 6:
                                emp_id = val
                                break
                    
                    if not emp_id:
                        skipped_rows += 1
                        skipped_details['no_emp_id'] += 1
                        continue
                    
                    # Skip keywords (but not employee IDs that might contain these as numbers)
                    emp_id_upper = emp_id.upper()
                    # Only skip if it's actually text keywords, not numeric IDs
                    if not emp_id.isdigit():
                        if any(kw in emp_id_upper for kw in ['TOTAL', 'GRAND', 'CCR', 'ACCT']):
                            skipped_rows += 1
                            skipped_details['keyword'] += 1
                            continue
                    
                    # Get net pay
                    net_pay = safe_float(row.iloc[net_pay_col])
                    
                    if net_pay <= 0:
                        skipped_rows += 1
                        skipped_details['zero_pay'] += 1
                        if processed_rows < 5:  # Show first few zero pay cases
                            print(f"  Skipping {emp_id}: Net Pay = {net_pay}")
                        continue
                    
                    # Look up account and name
                    account_no = account_lookup.get(emp_id)
                    employee_name = name_lookup.get(emp_id, f"Employee {emp_id}")
                    
                    if not account_no:
                        print(f"  Warning: No account for employee {emp_id}")
                        skipped_rows += 1
                        skipped_details['no_account'] += 1
                        continue
                    
                    # Add prefix
                    account_with_prefix = f"00{account_no}"
                    
                    result_data.append({
                        'Account No.': account_with_prefix,
                        'Net Pay': net_pay,
                        'Name': employee_name,
                        'Emp ID': emp_id  # Keep for debugging
                    })
                    
                    processed_rows += 1
                    
                    if processed_rows <= 5:
                        print(f"âœ“ {emp_id} -> {account_with_prefix}, {employee_name}, â‚±{net_pay:,.2f}")
                    
                except Exception as row_error:
                    print(f"  Error on row {idx}: {row_error}")
                    skipped_rows += 1
                    continue
            
            print(f"\n=== Summary ===")
            print(f"Total rows in file: {len(self.paste_df)}")
            print(f"Successfully converted: {processed_rows}")
            print(f"Skipped rows: {skipped_rows}")
            print(f"  - No employee ID: {skipped_details['no_emp_id']}")
            print(f"  - No account in DB: {skipped_details['no_account']}")
            print(f"  - Zero/negative pay: {skipped_details['zero_pay']}")
            print(f"  - Keyword rows: {skipped_details['keyword']}")
            
            if not result_data:
                raise ValueError(
                    f"No valid data found. Checked {len(self.paste_df)} rows.\n"
                    f"Please ensure:\n"
                    f"1. Employee IDs (6 digits) are in first columns\n"
                    f"2. Net Pay column has positive values\n"
                    f"3. Employee IDs match database file"
                )
            
            final_df = pd.DataFrame(result_data)
            
            # Calculate total before removing Emp ID column
            total_amount = final_df['Net Pay'].sum()
            print(f"\nTotal Net Pay: â‚±{total_amount:,.2f}")
            
            # Remove Emp ID column (was just for debugging)
            final_df = final_df[['Account No.', 'Net Pay', 'Name']]
            
            final_df = final_df.sort_values('Name').reset_index(drop=True)
            
            return final_df
            
        except Exception as e:
            print(f"Error: {e}")
            traceback.print_exc()
            raise

# ============================================================================
# EXCEL WRITER WITH ENHANCED FORMATTING
# ============================================================================

class FormattedExcelWriter:
    def __init__(self, filename, df, month, cutoff, dbase_df=None):
        self.filename = filename
        self.df = df
        self.month = month
        self.cutoff = cutoff
        self.dbase_df = dbase_df
        self.wb = openpyxl.Workbook()
        self.ws = self.wb.active
        self.ws.title = f"{MONTH_CONFIG[month]['code']}{'15' if cutoff == 'first' else '30'}"
        
    def write_headers(self):
        """Write company headers with enhanced formatting"""
        month_info = MONTH_CONFIG[self.month]
        
        if self.cutoff == 'first':
            period_text = f"{month_info['prev']} 26 - {self.month} 10"
            cutoff_text = f"{self.month} 15"
        else:
            period_text = f"{self.month} 11 - 25"
            cutoff_text = f"{self.month} {month_info['days']}"
        
        # Row 1: Company name (merged across columns A-F)
        self.ws.merge_cells('A1:F1')
        self.ws['A1'] = COMPANY_NAME
        self.ws['A1'].font = Font(name='Arial', size=12, bold=True)
        self.ws['A1'].alignment = Alignment(horizontal='left', vertical='center')
        self.ws.row_dimensions[1].height = 20
        
        # Row 2: Cut-off period
        self.ws.merge_cells('A2:F2')
        self.ws['A2'] = f"Cut-Off Period:  {period_text}, {YEAR}"
        self.ws['A2'].font = Font(name='Arial', size=10, bold=True)
        self.ws['A2'].alignment = Alignment(horizontal='left', vertical='center')
        
        # Row 3: Payroll period (red text)
        self.ws.merge_cells('A3:F3')
        self.ws['A3'] = f"Payroll Period:  {cutoff_text}, {YEAR}"
        self.ws['A3'].font = Font(name='Arial', size=10, bold=True, color='FF0000')
        self.ws['A3'].alignment = Alignment(horizontal='left', vertical='center')
        
        # Row 2 right side: Minimum wage
        self.ws.merge_cells('G2:I2')
        self.ws['G2'] = MIN_WAGE
        self.ws['G2'].font = Font(name='Arial', size=9)
        self.ws['G2'].alignment = Alignment(horizontal='left', vertical='center')
        
        # Row 4: Empty for spacing
        self.ws.row_dimensions[4].height = 10
        
        # Row 5: Empty for spacing
        self.ws.row_dimensions[5].height = 5
        
        # Row 6: Empty for spacing
        self.ws.row_dimensions[6].height = 5
        
        # Add merged header rows for grouping (Row 7)
        self.add_grouped_headers()
        
    def add_grouped_headers(self):
        """Add merged header cells for column grouping"""
        # Row 7 height
        self.ws.row_dimensions[7].height = 20
        
        # Define merged ranges and their labels
        merged_headers = [
            ('O7:Q7', 'DEDUCTION'),
            ('S7:U7', 'EMPLOYEE CONTRIBUTION'),
            ('Y7:AA7', 'NON-TAXABLE EARNINGS'),
            ('AE7:AG7', 'DEDUCTION FOR PAYROLL'),
            ('AJ7:AM7', 'EMPLOYER CONTRIBUTION'),
            ('AP7:AU7', 'Validation'),
            ('AW7:BB7', 'Difference')
        ]
        
        for cell_range, label in merged_headers:
            self.ws.merge_cells(cell_range)
            cell = self.ws[cell_range.split(':')[0]]
            cell.value = label
            cell.font = Font(name='Arial', size=9, bold=True)
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.fill = PatternFill(start_color='E0E0E0', end_color='E0E0E0', fill_type='solid')
            
            # Add border to merged header cells
            thin_border = Border(
                left=Side(style='thin', color='000000'),
                right=Side(style='thin', color='000000'),
                top=Side(style='thin', color='000000'),
                bottom=Side(style='thin', color='000000')
            )
            
            # Apply border to all cells in merged range
            start_col = openpyxl.utils.column_index_from_string(cell_range.split(':')[0][0])
            end_col = openpyxl.utils.column_index_from_string(cell_range.split(':')[1][0])
            for col in range(start_col, end_col + 1):
                self.ws.cell(row=7, column=col).border = thin_border
        
    def write_data(self):
        """Write dataframe to Excel with enhanced formatting"""
        # Column headers at row 8
        for col_idx, col_name in enumerate(self.df.columns, start=1):
            cell = self.ws.cell(row=8, column=col_idx, value=col_name)
            cell.font = Font(name='Arial', size=9, bold=True)
            cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
            cell.fill = PatternFill(start_color='E0E0E0', end_color='E0E0E0', fill_type='solid')
            
            # Add border
            cell.border = Border(
                left=Side(style='thin', color='000000'),
                right=Side(style='thin', color='000000'),
                top=Side(style='thin', color='000000'),
                bottom=Side(style='thin', color='000000')
            )
        
        # Set row 8 height
        self.ws.row_dimensions[8].height = 50
        
        # Write data starting at row 9
        for row_idx, row_data in enumerate(self.df.itertuples(index=False), start=9):
            row_height = 18  # Default row height
            is_total_row = False
            
            # Check if this is a total row
            if len(row_data) > 2:
                row_name = str(row_data[2]) if pd.notna(row_data[2]) else ''
                if any(keyword in row_name for keyword in ['TOTAL', 'GRAND']):
                    is_total_row = True
                    row_height = 22
            
            self.ws.row_dimensions[row_idx].height = row_height
            
            for col_idx, value in enumerate(row_data, start=1):
                cell = self.ws.cell(row=row_idx, column=col_idx, value=value)
                
                # Font formatting
                if is_total_row:
                    cell.font = Font(name='Arial', size=10, bold=True)
                else:
                    cell.font = Font(name='Arial', size=10)
                
                # Alignment
                cell.alignment = Alignment(vertical='center')
                
                # Center align specific columns (Employee ID column and some others)
                if col_idx in [2, 7]:
                    cell.alignment = Alignment(horizontal='center', vertical='center')
                elif col_idx == 3:  # Account number or name columns
                    cell.alignment = Alignment(horizontal='left', vertical='center')
                
                # Number formatting for currency columns (columns H onwards)
                if col_idx >= 8 and isinstance(value, (int, float)):
                    if value == 0:
                        cell.number_format = '_-* #,##0.00_-;-* #,##0.00_-;_-* "-"??_-;_-@_-'
                    else:
                        cell.number_format = '_-* #,##0.00_-;[Red]-* #,##0.00_-;_-* "-"??_-;_-@_-'
                    cell.alignment = Alignment(horizontal='right', vertical='center')
                
                # Add borders
                cell.border = Border(
                    left=Side(style='thin', color='000000'),
                    right=Side(style='thin', color='000000'),
                    top=Side(style='thin', color='000000'),
                    bottom=Side(style='thin', color='000000')
                )
    
    def apply_department_colors(self):
        """Apply department-specific color coding"""
        for row_idx, row in enumerate(self.df.itertuples(index=False), start=9):
            # Get the department/total name (column 3, index 2)
            row_name = str(row[2]) if len(row) > 2 else ''
            
            color = None
            is_bold = False
            merge_cols = False
            row_height = 18
            
            # Determine color based on row type
            if 'IND2001' in row_name or 'IND2005' in row_name:
                color = DEPT_COLORS['IND_PROD']
                is_bold = True
                merge_cols = True
                row_height = 22
            elif 'IND PROD TOTAL' in row_name:
                color = DEPT_COLORS['IND_PROD']
                is_bold = True
                merge_cols = True
                row_height = 24
            elif 'IND2101' in row_name or 'IND2102' in row_name:
                color = DEPT_COLORS['IND_QA']
                is_bold = True
                merge_cols = True
                row_height = 22
            elif any(x in row_name for x in ['IND202', 'IND203', 'IND204', 'IND205']):
                color = DEPT_COLORS['IND_QA_ALT']
                is_bold = True
                merge_cols = True
                row_height = 22
            elif 'IND QA TOTAL' in row_name:
                color = DEPT_COLORS['IND_QA_ALT']
                is_bold = True
                merge_cols = True
                row_height = 24
            elif 'IND503' in row_name or 'IND506' in row_name:
                color = DEPT_COLORS['IND_WAREHOUSE']
                is_bold = True
                merge_cols = True
                row_height = 22
            elif 'IND WAREHOUSE TOTAL' in row_name:
                color = DEPT_COLORS['IND_WAREHOUSE']
                is_bold = True
                merge_cols = True
                row_height = 24
            elif 'IND702' in row_name:
                color = DEPT_COLORS['IND_702']
                is_bold = True
                merge_cols = True
                row_height = 22
            elif 'D2001' in row_name or 'D2005' in row_name:
                color = DEPT_COLORS['DIRECT_PROD']
                is_bold = True
                merge_cols = True
                row_height = 22
            elif 'DIRECT PROD TOTAL' in row_name:
                color = DEPT_COLORS['DIRECT_PROD']
                is_bold = True
                merge_cols = True
                row_height = 24
            elif 'IND1002' in row_name:
                color = DEPT_COLORS['IND_1002']
                is_bold = True
                merge_cols = True
                row_height = 22
            elif 'GRAND TOTAL' in row_name:
                color = DEPT_COLORS['GRAND_TOTAL']
                is_bold = True
                merge_cols = True
                row_height = 26
            
            # Set row height
            if row_height > 18:
                self.ws.row_dimensions[row_idx].height = row_height
            
            # Apply formatting
            if color:
                for col_idx in range(1, min(41, len(self.df.columns) + 1)):
                    cell = self.ws.cell(row=row_idx, column=col_idx)
                    cell.fill = PatternFill(start_color=color, end_color=color, fill_type='solid')
                    
                    if is_bold:
                        cell.font = Font(name='Arial', size=10, bold=True)
                    
                    # Keep number formatting
                    if col_idx >= 8 and isinstance(cell.value, (int, float)):
                        if cell.value == 0:
                            cell.number_format = '_-* #,##0.00_-;-* #,##0.00_-;_-* "-"??_-;_-@_-'
                        else:
                            cell.number_format = '_-* #,##0.00_-;[Red]-* #,##0.00_-;_-* "-"??_-;_-@_-'
                        cell.alignment = Alignment(horizontal='right', vertical='center')
                
                # Merge cells C:E for total rows
                if merge_cols and row_idx <= self.ws.max_row:
                    try:
                        # Unmerge first if already merged
                        self.ws.unmerge_cells(f'C{row_idx}:E{row_idx}')
                    except:
                        pass
                    
                    try:
                        self.ws.merge_cells(f'C{row_idx}:E{row_idx}')
                        merged_cell = self.ws[f'C{row_idx}']
                        merged_cell.alignment = Alignment(horizontal='left', vertical='center')
                    except:
                        pass
    
    def apply_borders(self):
        """Apply professional borders to all data cells"""
        thin_border = Border(
            left=Side(style='thin', color='000000'),
            right=Side(style='thin', color='000000'),
            top=Side(style='thin', color='000000'),
            bottom=Side(style='thin', color='000000')
        )
        
        # Apply to data range (from row 7 to last row)
        for row in self.ws.iter_rows(min_row=7, max_row=self.ws.max_row, 
                                      min_col=1, max_col=min(40, len(self.df.columns))):
            for cell in row:
                if cell.value is not None or cell.row >= 8:
                    cell.border = thin_border
    
    def set_column_widths(self):
        """Set optimal column widths"""
        column_widths = {
            'A': 8,    # CCR Code
            'B': 7,    # Employee ID
            'C': 12,   # Account No
            'D': 25,   # Employee Name
            'E': 15,   # Department/Position
            'F': 0,    # Hidden column
            'G': 8,    # Center No
            'H': 12,   # Basic Pay
            'I': 10,   # OT columns
            'J': 10,
            'K': 10,
            'L': 10,
            'M': 10,
            'N': 10,
            'O': 10,
            'P': 10,
            'Q': 10,
            'R': 11,   # Total Deduct
            'S': 10,   # SSS
            'T': 10,   # PhilHealth
            'U': 10,   # Pag-IBIG
        }
        
        # Set specific widths
        for col_letter, width in column_widths.items():
            if width == 0:
                self.ws.column_dimensions[col_letter].hidden = True
            else:
                self.ws.column_dimensions[col_letter].width = width
        
        # Set default width for remaining columns (V onwards)
        for col_idx in range(22, 50):
            col_letter = openpyxl.utils.get_column_letter(col_idx)
            self.ws.column_dimensions[col_letter].width = 10
    
    def add_signatures(self):
        """Add approval signatures at the bottom"""
        last_row = self.ws.max_row
        
        # Add blank row for spacing after data
        self.ws.row_dimensions[last_row + 1].height = 15
        
        # Add additional info section (Average Days, Med Fee, etc.)
        info_row = last_row + 3
        
        self.ws.cell(row=info_row, column=6).value = "Average Days:"
        self.ws.cell(row=info_row, column=6).font = Font(name='Arial', size=9, bold=True)
        self.ws.cell(row=info_row, column=6).alignment = Alignment(horizontal='left', vertical='center')
        
        # You can add formula here if needed
        # self.ws.cell(row=info_row, column=8).value = formula for average days
        
        # Medical fees section
        self.ws.cell(row=info_row, column=16).value = "Medical Fee:"
        self.ws.cell(row=info_row, column=16).font = Font(name='Arial', size=9, bold=True)
        
        # Benefits section on the right
        benefits_start = info_row
        self.ws.cell(row=benefits_start, column=34).value = "HMI:"
        self.ws.cell(row=benefits_start, column=34).font = Font(name='Arial', size=9, bold=True)
        
        self.ws.cell(row=benefits_start + 1, column=34).value = "Optical:"
        self.ws.cell(row=benefits_start + 1, column=34).font = Font(name='Arial', size=9, bold=True)
        
        self.ws.cell(row=benefits_start + 2, column=34).value = "Dental:"
        self.ws.cell(row=benefits_start + 2, column=34).font = Font(name='Arial', size=9, bold=True)
        
        # Add spacing before signatures
        self.ws.row_dimensions[last_row + 7].height = 20
        self.ws.row_dimensions[last_row + 8].height = 20
        
        # Approval section - well-spaced
        approval_start = last_row + 12
        
        # APPROVED BY section (columns F-H)
        self.ws.merge_cells(f'F{approval_start}:H{approval_start}')
        approved_cell = self.ws[f'F{approval_start}']
        approved_cell.value = "APPROVED BY:"
        approved_cell.font = Font(name='Arial', size=10, bold=True)
        approved_cell.alignment = Alignment(horizontal='center', vertical='center')
        
        # Add blank rows for signature
        self.ws.row_dimensions[approval_start + 1].height = 10
        self.ws.row_dimensions[approval_start + 2].height = 30
        
        # Signature line
        self.ws.merge_cells(f'F{approval_start + 3}:H{approval_start + 3}')
        sig_line = self.ws[f'F{approval_start + 3}']
        sig_line.value = "________________________________"
        sig_line.font = Font(name='Arial', size=10)
        sig_line.alignment = Alignment(horizontal='center', vertical='center')
        
        # Name
        self.ws.merge_cells(f'F{approval_start + 4}:H{approval_start + 4}')
        name_cell = self.ws[f'F{approval_start + 4}']
        name_cell.value = "YEN-PAN HSUEH"
        name_cell.font = Font(name='Arial', size=11, bold=True)
        name_cell.alignment = Alignment(horizontal='center', vertical='center')
        
        # Position
        self.ws.merge_cells(f'F{approval_start + 5}:H{approval_start + 5}')
        position_cell = self.ws[f'F{approval_start + 5}']
        position_cell.value = "Director"
        position_cell.font = Font(name='Arial', size=10)
        position_cell.alignment = Alignment(horizontal='center', vertical='center')
        
        # PREPARED BY section (columns K-M)
        self.ws.merge_cells(f'K{approval_start}:M{approval_start}')
        prepared_cell = self.ws[f'K{approval_start}']
        prepared_cell.value = "PREPARED BY:"
        prepared_cell.font = Font(name='Arial', size=10, bold=True)
        prepared_cell.alignment = Alignment(horizontal='center', vertical='center')
        
        # Signature line
        self.ws.merge_cells(f'K{approval_start + 3}:M{approval_start + 3}')
        prep_sig_line = self.ws[f'K{approval_start + 3}']
        prep_sig_line.value = "________________________________"
        prep_sig_line.font = Font(name='Arial', size=10)
        prep_sig_line.alignment = Alignment(horizontal='center', vertical='center')
        
        # Name
        self.ws.merge_cells(f'K{approval_start + 4}:M{approval_start + 4}')
        prep_name = self.ws[f'K{approval_start + 4}']
        prep_name.value = "RACQUEL CABRAL"
        prep_name.font = Font(name='Arial', size=11, bold=True)
        prep_name.alignment = Alignment(horizontal='center', vertical='center')
        
        # Position
        self.ws.merge_cells(f'K{approval_start + 5}:M{approval_start + 5}')
        prep_position = self.ws[f'K{approval_start + 5}']
        prep_position.value = "Manager"
        prep_position.font = Font(name='Arial', size=10)
        prep_position.alignment = Alignment(horizontal='center', vertical='center')
        
        # Department
        self.ws.merge_cells(f'K{approval_start + 6}:M{approval_start + 6}')
        prep_dept = self.ws[f'K{approval_start + 6}']
        prep_dept.value = "HR/ADMIN Department"
        prep_dept.font = Font(name='Arial', size=9, italic=True)
        prep_dept.alignment = Alignment(horizontal='center', vertical='center')
        
        # Add final spacing
        self.ws.row_dimensions[approval_start + 7].height = 20
    
    def freeze_panes(self):
        """Freeze header rows and first columns"""
        self.ws.freeze_panes = 'D9'  # Freeze first 3 columns and 8 rows
    
    def add_print_settings(self):
        """Configure print settings"""
        from openpyxl.worksheet.page import PageMargins
        
        # Set margins
        self.ws.page_margins = PageMargins(left=0.5, right=0.5, top=0.75, bottom=0.75)
        
        # Set to landscape
        self.ws.page_setup.orientation = self.ws.ORIENTATION_LANDSCAPE
        
        # Fit to page
        self.ws.page_setup.fitToWidth = 1
        self.ws.page_setup.fitToHeight = 0
        
        # Set print area (adjust based on actual columns)
        # self.ws.print_area = f'A1:AN{self.ws.max_row}'
        
        # Repeat rows 1-8 on each page
        self.ws.print_title_rows = '1:8'
    
    def save(self):
        """Save the workbook with all formatting applied"""
        self.write_headers()
        self.write_data()
        self.set_column_widths()
        self.apply_department_colors()
        self.apply_borders()
        self.add_signatures()
        self.freeze_panes()
        self.add_print_settings()
        
        # Add summary sheets
        self.add_cost_center_summary()
        self.add_cash_payroll_list()
        
        # Save workbook
        self.wb.save(self.filename)
        return self.filename
    
    def add_cost_center_summary(self):
        """Add Cost Center Summary sheet"""
        ws_summary = self.wb.create_sheet("Cost Center Summary")
        
        # Header
        ws_summary.merge_cells('A1:F1')
        ws_summary['A1'] = COMPANY_NAME
        ws_summary['A1'].font = Font(name='Arial', size=14, bold=True, color='C00000')
        ws_summary['A1'].alignment = Alignment(horizontal='center', vertical='center')
        ws_summary.row_dimensions[1].height = 25
        
        ws_summary.merge_cells('A2:F2')
        ws_summary['A2'] = "COST CENTER SUMMARY"
        ws_summary['A2'].font = Font(name='Arial', size=12, bold=True)
        ws_summary['A2'].alignment = Alignment(horizontal='center', vertical='center')
        ws_summary.row_dimensions[2].height = 22
        
        month_info = MONTH_CONFIG[self.month]
        if self.cutoff == 'first':
            period_text = f"{month_info['prev']} 26 - {self.month} 10"
            cutoff_text = f"{self.month} 15"
        else:
            period_text = f"{self.month} 11 - 25"
            cutoff_text = f"{self.month} {month_info['days']}"
        
        ws_summary.merge_cells('A3:F3')
        ws_summary['A3'] = f"Period: {period_text}, {YEAR} | Cutoff: {cutoff_text}, {YEAR}"
        ws_summary['A3'].font = Font(name='Arial', size=10)
        ws_summary['A3'].alignment = Alignment(horizontal='center', vertical='center')
        
        ws_summary.row_dimensions[4].height = 15
        
        # Column headers
        headers = ['Cost Center', 'Employee Count', 'Basic Salary', 'Total OT', 'Gross Pay', 'Net Pay']
        for col_idx, header in enumerate(headers, start=1):
            cell = ws_summary.cell(row=5, column=col_idx, value=header)
            cell.font = Font(name='Arial', size=10, bold=True, color='FFFFFF')
            cell.fill = PatternFill(start_color='C00000', end_color='C00000', fill_type='solid')
            cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
            cell.border = Border(
                left=Side(style='thin'), right=Side(style='thin'),
                top=Side(style='thin'), bottom=Side(style='thin')
            )
        
        ws_summary.row_dimensions[5].height = 30
        
        # Get cost center data from main sheet
        ccr_data = {}
        row_idx = 6
        
        for idx, row in self.df.iterrows():
            ccr_code = row.iloc[0] if pd.notna(row.iloc[0]) else ''
            row_name = str(row.iloc[2]) if len(row) > 2 else ''
            
            # Skip empty rows and grand total
            if not ccr_code or 'GRAND TOTAL' in row_name:
                continue
            
            # Identify department totals
            if 'TOTAL' in row_name:
                emp_count = safe_int(row.iloc[1]) if len(row) > 1 else 0
                basic_salary = safe_float(row.iloc[7]) if len(row) > 7 else 0
                ot_total = 0
                if len(row) > 10:
                    ot_total = safe_float(row.iloc[8]) + safe_float(row.iloc[9]) + safe_float(row.iloc[10])
                gross_pay = safe_float(row.iloc[29]) if len(row) > 29 else 0
                net_pay = safe_float(row.iloc[33]) if len(row) > 33 else 0
                
                # Determine cost center group
                if 'IND PROD TOTAL' in row_name:
                    ccr_name = 'IND PRODUCTION'
                elif 'IND QA TOTAL' in row_name:
                    ccr_name = 'IND QA'
                elif 'IND WAREHOUSE TOTAL' in row_name:
                    ccr_name = 'IND WAREHOUSE'
                elif 'DIRECT PROD TOTAL' in row_name:
                    ccr_name = 'DIRECT PRODUCTION'
                elif 'IND702' in row_name:
                    ccr_name = 'IND702'
                elif 'IND1002' in row_name:
                    ccr_name = 'IND1002'
                else:
                    continue
                
                # Write cost center row
                ws_summary.cell(row=row_idx, column=1, value=ccr_name).font = Font(name='Arial', size=10, bold=True)
                ws_summary.cell(row=row_idx, column=2, value=emp_count).alignment = Alignment(horizontal='center')
                ws_summary.cell(row=row_idx, column=3, value=basic_salary).number_format = 'â‚±#,##0.00'
                ws_summary.cell(row=row_idx, column=4, value=ot_total).number_format = 'â‚±#,##0.00'
                ws_summary.cell(row=row_idx, column=5, value=gross_pay).number_format = 'â‚±#,##0.00'
                ws_summary.cell(row=row_idx, column=6, value=net_pay).number_format = 'â‚±#,##0.00'
                
                # Apply borders and alternating colors
                fill_color = 'F2F2F2' if row_idx % 2 == 0 else 'FFFFFF'
                for col in range(1, 7):
                    cell = ws_summary.cell(row=row_idx, column=col)
                    cell.fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
                    cell.border = Border(
                        left=Side(style='thin'), right=Side(style='thin'),
                        top=Side(style='thin'), bottom=Side(style='thin')
                    )
                
                ws_summary.row_dimensions[row_idx].height = 20
                row_idx += 1
        
        # Grand total row
        ws_summary.cell(row=row_idx, column=1, value='GRAND TOTAL').font = Font(name='Arial', size=11, bold=True)
        
        for col in range(2, 7):
            formula = f'=SUM({openpyxl.utils.get_column_letter(col)}6:{openpyxl.utils.get_column_letter(col)}{row_idx-1})'
            cell = ws_summary.cell(row=row_idx, column=col, value=formula)
            cell.font = Font(name='Arial', size=11, bold=True, color='C00000')
            if col > 2:
                cell.number_format = 'â‚±#,##0.00'
            else:
                cell.alignment = Alignment(horizontal='center')
            cell.fill = PatternFill(start_color='FFE699', end_color='FFE699', fill_type='solid')
            cell.border = Border(
                left=Side(style='medium'), right=Side(style='medium'),
                top=Side(style='double'), bottom=Side(style='double')
            )
        
        ws_summary.row_dimensions[row_idx].height = 25
        
        # Set column widths
        ws_summary.column_dimensions['A'].width = 25
        ws_summary.column_dimensions['B'].width = 15
        ws_summary.column_dimensions['C'].width = 16
        ws_summary.column_dimensions['D'].width = 14
        ws_summary.column_dimensions['E'].width = 16
        ws_summary.column_dimensions['F'].width = 16
    
    def add_cash_payroll_list(self):
        """Add Cash Payroll List sheet for employees without bank accounts"""
        ws_cash = self.wb.create_sheet("Cash Payroll")
        
        # Header
        ws_cash.merge_cells('A1:G1')
        ws_cash['A1'] = COMPANY_NAME
        ws_cash['A1'].font = Font(name='Arial', size=14, bold=True, color='C00000')
        ws_cash['A1'].alignment = Alignment(horizontal='center', vertical='center')
        ws_cash.row_dimensions[1].height = 25
        
        ws_cash.merge_cells('A2:G2')
        ws_cash['A2'] = "CASH PAYROLL - Employees Without Bank Accounts"
        ws_cash['A2'].font = Font(name='Arial', size=12, bold=True)
        ws_cash['A2'].alignment = Alignment(horizontal='center', vertical='center')
        ws_cash.row_dimensions[2].height = 22
        
        month_info = MONTH_CONFIG[self.month]
        if self.cutoff == 'first':
            cutoff_text = f"{self.month} 15, {YEAR}"
        else:
            cutoff_text = f"{self.month} {month_info['days']}, {YEAR}"
        
        ws_cash.merge_cells('A3:G3')
        ws_cash['A3'] = f"Payroll Period: {cutoff_text}"
        ws_cash['A3'].font = Font(name='Arial', size=10)
        ws_cash['A3'].alignment = Alignment(horizontal='center', vertical='center')
        
        ws_cash.row_dimensions[4].height = 15
        
        # Column headers
        headers = ['Cost Center', 'Emp ID', 'Employee Name', 'Position', 'Net Pay', 'Signature', 'Remarks']
        for col_idx, header in enumerate(headers, start=1):
            cell = ws_cash.cell(row=5, column=col_idx, value=header)
            cell.font = Font(name='Arial', size=10, bold=True, color='FFFFFF')
            cell.fill = PatternFill(start_color='C00000', end_color='C00000', fill_type='solid')
            cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
            cell.border = Border(
                left=Side(style='thin'), right=Side(style='thin'),
                top=Side(style='thin'), bottom=Side(style='thin')
            )
        
        ws_cash.row_dimensions[5].height = 30
        
        # Create account lookup if dbase exists
        account_lookup = {}
        if self.dbase_df is not None:
            for idx, row in self.dbase_df.iterrows():
                emp_id = str(row.iloc[0]).strip() if pd.notna(row.iloc[0]) else None
                if emp_id and emp_id.isdigit():
                    acct = row.iloc[3] if len(row) > 3 and pd.notna(row.iloc[3]) else None
                    account_lookup[emp_id] = acct
        
        # Get employees without bank accounts
        row_idx = 6
        cash_employees = []
        
        for idx, row in self.df.iterrows():
            ccr_code = str(row.iloc[0]) if pd.notna(row.iloc[0]) else ''
            emp_id = str(row.iloc[1]) if len(row) > 1 and pd.notna(row.iloc[1]) else ''
            emp_name_parts = []
            
            # Skip total rows
            if 'TOTAL' in str(row.iloc[2]) or not emp_id.isdigit():
                continue
            
            # Check if employee has account
            has_account = account_lookup.get(emp_id)
            
            if not has_account or pd.isna(has_account):
                # Get employee details
                if len(row) > 2:
                    emp_name_parts.append(str(row.iloc[3]) if pd.notna(row.iloc[3]) else '')  # Last
                    emp_name_parts.append(str(row.iloc[4]) if len(row) > 4 and pd.notna(row.iloc[4]) else '')  # First
                    emp_name_parts.append(str(row.iloc[5]) if len(row) > 5 and pd.notna(row.iloc[5]) else '')  # Middle
                
                emp_name = ', '.join([p for p in emp_name_parts if p and p != 'nan'])
                position = "Daily Paid"
                net_pay = safe_float(row.iloc[33]) if len(row) > 33 else 0
                
                if net_pay > 0:
                    cash_employees.append({
                        'ccr': ccr_code,
                        'emp_id': emp_id,
                        'name': emp_name,
                        'position': position,
                        'net_pay': net_pay
                    })
        
        # Write cash employees
        for emp in sorted(cash_employees, key=lambda x: (x['ccr'], x['name'])):
            ws_cash.cell(row=row_idx, column=1, value=emp['ccr'])
            ws_cash.cell(row=row_idx, column=2, value=emp['emp_id']).alignment = Alignment(horizontal='center')
            ws_cash.cell(row=row_idx, column=3, value=emp['name'])
            ws_cash.cell(row=row_idx, column=4, value=emp['position'])
            ws_cash.cell(row=row_idx, column=5, value=emp['net_pay']).number_format = 'â‚±#,##0.00'
            ws_cash.cell(row=row_idx, column=6, value='')  # Signature
            ws_cash.cell(row=row_idx, column=7, value='NO BANK ACCOUNT')
            
            # Apply formatting
            fill_color = 'FFF2CC' if row_idx % 2 == 0 else 'FFFFFF'
            for col in range(1, 8):
                cell = ws_cash.cell(row=row_idx, column=col)
                cell.fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
                cell.border = Border(
                    left=Side(style='thin'), right=Side(style='thin'),
                    top=Side(style='thin'), bottom=Side(style='thin')
                )
                cell.font = Font(name='Arial', size=10)
            
            ws_cash.row_dimensions[row_idx].height = 22
            row_idx += 1
        
        # Total row
        if len(cash_employees) > 0:
            ws_cash.merge_cells(f'A{row_idx}:D{row_idx}')
            ws_cash.cell(row=row_idx, column=1, value=f'TOTAL CASH PAYROLL ({len(cash_employees)} Employees)')
            ws_cash.cell(row=row_idx, column=1).font = Font(name='Arial', size=11, bold=True)
            ws_cash.cell(row=row_idx, column=1).alignment = Alignment(horizontal='right', vertical='center')
            
            formula = f'=SUM(E6:E{row_idx-1})'
            ws_cash.cell(row=row_idx, column=5, value=formula)
            ws_cash.cell(row=row_idx, column=5).font = Font(name='Arial', size=11, bold=True, color='C00000')
            ws_cash.cell(row=row_idx, column=5).number_format = 'â‚±#,##0.00'
            
            for col in range(1, 8):
                cell = ws_cash.cell(row=row_idx, column=col)
                cell.fill = PatternFill(start_color='FFE699', end_color='FFE699', fill_type='solid')
                cell.border = Border(
                    left=Side(style='medium'), right=Side(style='medium'),
                    top=Side(style='double'), bottom=Side(style='double')
                )
        else:
            ws_cash.cell(row=row_idx, column=1, value='No employees without bank accounts')
            ws_cash.cell(row=row_idx, column=1).font = Font(name='Arial', size=10, italic=True)
        
        # Set column widths
        ws_cash.column_dimensions['A'].width = 12
        ws_cash.column_dimensions['B'].width = 10
        ws_cash.column_dimensions['C'].width = 30
        ws_cash.column_dimensions['D'].width = 15
        ws_cash.column_dimensions['E'].width = 15
        ws_cash.column_dimensions['F'].width = 25
        ws_cash.column_dimensions['G'].width = 20

# ============================================================================
# BDO SHEET CREATION HELPERS
# ============================================================================

def create_bdo_sheet(wb, sheet_name, df, total_employees, total_amount):
    """Create BDO bank payroll sheet"""
    ws = wb.create_sheet(sheet_name)
    
    # Header
    ws.merge_cells('A1:E1')
    ws['A1'] = "BANCO DE ORO (BDO) UNIBANK, INC."
    ws['A1'].font = Font(name='Arial', size=14, bold=True, color='0033A0')
    ws['A1'].alignment = Alignment(horizontal='center', vertical='center')
    ws.row_dimensions[1].height = 25
    
    ws.merge_cells('A2:E2')
    ws['A2'] = "Bank Payroll Crediting File"
    ws['A2'].font = Font(name='Arial', size=12, bold=True)
    ws['A2'].alignment = Alignment(horizontal='center', vertical='center')
    ws.row_dimensions[2].height = 22
    
    ws.merge_cells('A3:E3')
    ws['A3'] = COMPANY_NAME
    ws['A3'].font = Font(name='Arial', size=11, bold=True)
    ws['A3'].alignment = Alignment(horizontal='center', vertical='center')
    
    ws.merge_cells('A4:E4')
    ws['A4'] = f"Generated: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}"
    ws['A4'].font = Font(name='Arial', size=9, italic=True)
    ws['A4'].alignment = Alignment(horizontal='center', vertical='center')
    
    ws.row_dimensions[5].height = 10
    
    # Summary
    ws['A6'] = "Total Employees:"
    ws['A6'].font = Font(name='Arial', size=10, bold=True)
    ws['B6'] = total_employees
    ws['B6'].font = Font(name='Arial', size=10)
    
    ws['D6'] = "Total Amount:"
    ws['D6'].font = Font(name='Arial', size=10, bold=True)
    ws['D6'].alignment = Alignment(horizontal='right')
    ws['E6'] = total_amount
    ws['E6'].font = Font(name='Arial', size=10, bold=True, color='006100')
    ws['E6'].number_format = 'â‚±#,##0.00'
    ws['E6'].alignment = Alignment(horizontal='right')
    
    ws.row_dimensions[7].height = 8
    
    # Headers
    headers = ['Account Number', 'Net Pay Amount', 'Employee Name', 'Status', 'Remarks']
    header_colors = ['4472C4', '4472C4', '4472C4', '70AD47', 'ED7D31']
    
    for col_idx, (header, color) in enumerate(zip(headers, header_colors), start=1):
        cell = ws.cell(row=8, column=col_idx, value=header)
        cell.font = Font(name='Arial', size=10, bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color=color, end_color=color, fill_type='solid')
        cell.alignment = Alignment(horizontal='center', vertical='center')
        cell.border = Border(
            left=Side(style='medium'), right=Side(style='medium'),
            top=Side(style='medium'), bottom=Side(style='medium')
        )
    
    ws.row_dimensions[8].height = 35
    
    # Data
    for row_idx, row_data in enumerate(df.itertuples(index=False), start=9):
        fill_color = 'F2F2F2' if row_idx % 2 == 0 else 'FFFFFF'
        
        ws.cell(row=row_idx, column=1, value=row_data[0]).font = Font(name='Courier New', size=10, bold=True)
        ws.cell(row=row_idx, column=1).alignment = Alignment(horizontal='center')
        ws.cell(row=row_idx, column=1).fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        ws.cell(row=row_idx, column=2, value=row_data[1]).font = Font(name='Arial', size=10, bold=True)
        ws.cell(row=row_idx, column=2).number_format = 'â‚±#,##0.00'
        ws.cell(row=row_idx, column=2).alignment = Alignment(horizontal='right')
        ws.cell(row=row_idx, column=2).fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        ws.cell(row=row_idx, column=3, value=row_data[2]).font = Font(name='Arial', size=10)
        ws.cell(row=row_idx, column=3).fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        ws.cell(row=row_idx, column=4, value="Ready").font = Font(name='Arial', size=9, bold=True, color='006100')
        ws.cell(row=row_idx, column=4).alignment = Alignment(horizontal='center')
        ws.cell(row=row_idx, column=4).fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        ws.cell(row=row_idx, column=5, value="").fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        for col in range(1, 6):
            ws.cell(row=row_idx, column=col).border = Border(
                left=Side(style='thin', color='CCCCCC'),
                right=Side(style='thin', color='CCCCCC'),
                top=Side(style='thin', color='CCCCCC'),
                bottom=Side(style='thin', color='CCCCCC')
            )
        
        ws.row_dimensions[row_idx].height = 22
    
    # Total row
    footer_row = len(df) + 9
    ws.row_dimensions[footer_row].height = 15
    footer_row += 1
    
    ws['A' + str(footer_row)] = "TOTAL:"
    ws['A' + str(footer_row)].font = Font(name='Arial', size=11, bold=True)
    ws['A' + str(footer_row)].alignment = Alignment(horizontal='right')
    ws['A' + str(footer_row)].fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
    
    ws.cell(row=footer_row, column=2, value=f'=SUM(B9:B{footer_row-2})')
    ws.cell(row=footer_row, column=2).font = Font(name='Arial', size=11, bold=True, color='C00000')
    ws.cell(row=footer_row, column=2).number_format = 'â‚±#,##0.00'
    ws.cell(row=footer_row, column=2).alignment = Alignment(horizontal='right')
    ws.cell(row=footer_row, column=2).fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
    
    ws.merge_cells(f'C{footer_row}:E{footer_row}')
    ws.cell(row=footer_row, column=3, value=f"{total_employees} Employees")
    ws.cell(row=footer_row, column=3).font = Font(name='Arial', size=10, bold=True)
    ws.cell(row=footer_row, column=3).alignment = Alignment(horizontal='center')
    ws.cell(row=footer_row, column=3).fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
    
    for col in range(1, 6):
        ws.cell(row=footer_row, column=col).border = Border(
            left=Side(style='medium'), right=Side(style='medium'),
            top=Side(style='double'), bottom=Side(style='double')
        )
    
    ws.row_dimensions[footer_row].height = 28
    
    # Column widths
    ws.column_dimensions['A'].width = 18
    ws.column_dimensions['B'].width = 16
    ws.column_dimensions['C'].width = 35
    ws.column_dimensions['D'].width = 12
    ws.column_dimensions['E'].width = 20
    
    ws.freeze_panes = 'A9'

def create_cash_sheet(wb, sheet_name, df, total_employees, total_amount):
    """Create cash payroll sheet"""
    ws = wb.create_sheet(sheet_name)
    
    # Header
    ws.merge_cells('A1:F1')
    ws['A1'] = "CASH PAYROLL"
    ws['A1'].font = Font(name='Arial', size=14, bold=True, color='C00000')
    ws['A1'].alignment = Alignment(horizontal='center', vertical='center')
    ws.row_dimensions[1].height = 25
    
    ws.merge_cells('A2:F2')
    ws['A2'] = "Employees Without Bank Accounts"
    ws['A2'].font = Font(name='Arial', size=12, bold=True)
    ws['A2'].alignment = Alignment(horizontal='center', vertical='center')
    ws.row_dimensions[2].height = 22
    
    ws.merge_cells('A3:F3')
    ws['A3'] = COMPANY_NAME
    ws['A3'].font = Font(name='Arial', size=11, bold=True)
    ws['A3'].alignment = Alignment(horizontal='center', vertical='center')
    
    ws.merge_cells('A4:F4')
    ws['A4'] = f"Generated: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}"
    ws['A4'].font = Font(name='Arial', size=9, italic=True)
    ws['A4'].alignment = Alignment(horizontal='center', vertical='center')
    
    ws.row_dimensions[5].height = 10
    
    # Summary
    ws['A6'] = "Total Employees:"
    ws['A6'].font = Font(name='Arial', size=10, bold=True)
    ws['B6'] = total_employees
    ws['B6'].font = Font(name='Arial', size=10)
    
    ws['E6'] = "Total Cash:"
    ws['E6'].font = Font(name='Arial', size=10, bold=True)
    ws['E6'].alignment = Alignment(horizontal='right')
    ws['F6'] = total_amount
    ws['F6'].font = Font(name='Arial', size=10, bold=True, color='C00000')
    ws['F6'].number_format = 'â‚±#,##0.00'
    ws['F6'].alignment = Alignment(horizontal='right')
    
    ws.row_dimensions[7].height = 8
    
    # Headers
    headers = ['Emp ID', 'Employee Name', 'Net Pay', 'Signature', 'Date Received', 'Remarks']
    header_color = 'C00000'
    
    for col_idx, header in enumerate(headers, start=1):
        cell = ws.cell(row=8, column=col_idx, value=header)
        cell.font = Font(name='Arial', size=10, bold=True, color='FFFFFF')
        cell.fill = PatternFill(start_color=header_color, end_color=header_color, fill_type='solid')
        cell.alignment = Alignment(horizontal='center', vertical='center')
        cell.border = Border(
            left=Side(style='medium'), right=Side(style='medium'),
            top=Side(style='medium'), bottom=Side(style='medium')
        )
    
    ws.row_dimensions[8].height = 35
    
    # Data
    for row_idx, row_data in enumerate(df.itertuples(index=False), start=9):
        fill_color = 'FFF2CC' if row_idx % 2 == 0 else 'FFFFFF'
        
        ws.cell(row=row_idx, column=1, value=row_data[0]).font = Font(name='Arial', size=10)
        ws.cell(row=row_idx, column=1).alignment = Alignment(horizontal='center')
        ws.cell(row=row_idx, column=1).fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        ws.cell(row=row_idx, column=2, value=row_data[2]).font = Font(name='Arial', size=10)
        ws.cell(row=row_idx, column=2).fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        ws.cell(row=row_idx, column=3, value=row_data[1]).font = Font(name='Arial', size=10, bold=True)
        ws.cell(row=row_idx, column=3).number_format = 'â‚±#,##0.00'
        ws.cell(row=row_idx, column=3).alignment = Alignment(horizontal='right')
        ws.cell(row=row_idx, column=3).fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        for col in [4, 5, 6]:
            ws.cell(row=row_idx, column=col, value="")
            ws.cell(row=row_idx, column=col).fill = PatternFill(start_color=fill_color, end_color=fill_color, fill_type='solid')
        
        ws.cell(row=row_idx, column=6, value="NO BANK ACCOUNT")
        ws.cell(row=row_idx, column=6).font = Font(name='Arial', size=9, italic=True, color='C00000')
        
        for col in range(1, 7):
            ws.cell(row=row_idx, column=col).border = Border(
                left=Side(style='thin', color='CCCCCC'),
                right=Side(style='thin', color='CCCCCC'),
                top=Side(style='thin', color='CCCCCC'),
                bottom=Side(style='thin', color='CCCCCC')
            )
        
        ws.row_dimensions[row_idx].height = 25
    
    # Total row
    footer_row = len(df) + 9
    ws.row_dimensions[footer_row].height = 15
    footer_row += 1
    
    ws.merge_cells(f'A{footer_row}:B{footer_row}')
    ws.cell(row=footer_row, column=1, value="TOTAL CASH PAYROLL:")
    ws.cell(row=footer_row, column=1).font = Font(name='Arial', size=11, bold=True)
    ws.cell(row=footer_row, column=1).alignment = Alignment(horizontal='right')
    ws.cell(row=footer_row, column=1).fill = PatternFill(start_color='FFE699', end_color='FFE699', fill_type='solid')
    
    ws.cell(row=footer_row, column=3, value=f'=SUM(C9:C{footer_row-2})')
    ws.cell(row=footer_row, column=3).font = Font(name='Arial', size=11, bold=True, color='C00000')
    ws.cell(row=footer_row, column=3).number_format = 'â‚±#,##0.00'
    ws.cell(row=footer_row, column=3).alignment = Alignment(horizontal='right')
    ws.cell(row=footer_row, column=3).fill = PatternFill(start_color='FFE699', end_color='FFE699', fill_type='solid')
    
    ws.merge_cells(f'D{footer_row}:F{footer_row}')
    ws.cell(row=footer_row, column=4, value=f"{total_employees} Employees")
    ws.cell(row=footer_row, column=4).font = Font(name='Arial', size=10, bold=True)
    ws.cell(row=footer_row, column=4).alignment = Alignment(horizontal='center')
    ws.cell(row=footer_row, column=4).fill = PatternFill(start_color='FFE699', end_color='FFE699', fill_type='solid')
    
    for col in range(1, 7):
        ws.cell(row=footer_row, column=col).border = Border(
            left=Side(style='medium'), right=Side(style='medium'),
            top=Side(style='double'), bottom=Side(style='double')
        )
    
    ws.row_dimensions[footer_row].height = 28
    
    # Column widths
    ws.column_dimensions['A'].width = 10
    ws.column_dimensions['B'].width = 30
    ws.column_dimensions['C'].width = 15
    ws.column_dimensions['D'].width = 25
    ws.column_dimensions['E'].width = 15
    ws.column_dimensions['F'].width = 20
    
    ws.freeze_panes = 'A9'

@app.route('/')
def index():
    """Main page"""
    return render_template('index.html', months=list(MONTH_CONFIG.keys()))

@app.route('/upload', methods=['POST'])
def upload_files():
    """Handle file uploads"""
    try:
        if 'payroll_file' not in request.files or 'dbase_file' not in request.files:
            return jsonify({'error': 'Missing required files'}), 400
        
        payroll_file = request.files['payroll_file']
        dbase_file = request.files['dbase_file']
        month = request.form.get('month')
        cutoff = request.form.get('cutoff')
        
        if not month or not cutoff:
            return jsonify({'error': 'Month and cutoff are required'}), 400
        
        if payroll_file.filename == '' or dbase_file.filename == '':
            return jsonify({'error': 'No files selected'}), 400
        
        if not (allowed_file(payroll_file.filename) and allowed_file(dbase_file.filename)):
            return jsonify({'error': 'Invalid file type'}), 400
        
        # Save uploaded files
        payroll_filename = secure_filename(payroll_file.filename)
        dbase_filename = secure_filename(dbase_file.filename)
        
        payroll_path = os.path.join(app.config['UPLOAD_FOLDER'], payroll_filename)
        dbase_path = os.path.join(app.config['UPLOAD_FOLDER'], dbase_filename)
        
        payroll_file.save(payroll_path)
        dbase_file.save(dbase_path)
        
        # Read files
        payroll_df = pd.read_excel(payroll_path)
        dbase_df = pd.read_excel(dbase_path)
        
        # Process payroll
        processor = PayrollProcessor(payroll_df, dbase_df, month, cutoff)
        result_df = processor.process()
        
        # Generate output filename
        month_code = MONTH_CONFIG[month]['code']
        cutoff_code = '15' if cutoff == 'first' else '30'
        output_filename = f"Payroll_{month_code}{cutoff_code}_{YEAR}.xlsx"
        output_path = os.path.join(app.config['UPLOAD_FOLDER'], output_filename)
        
        # Write formatted Excel with summary sheets
        writer = FormattedExcelWriter(output_path, result_df, month, cutoff, dbase_df)
        writer.save()
        
        return jsonify({
            'success': True,
            'message': 'Payroll processed successfully',
            'download_url': f'/download/{output_filename}'
        })
        
    except Exception as e:
        print(f"Error in upload_files: {traceback.format_exc()}")
        return jsonify({'error': str(e)}), 500

@app.route('/convert_bdo', methods=['POST'])
def convert_bdo():
    """Convert to BDO format"""
    try:
        if 'payroll_file' not in request.files or 'dbase_file' not in request.files:
            return jsonify({'error': 'Missing required files'}), 400
        
        payroll_file = request.files['payroll_file']
        dbase_file = request.files['dbase_file']
        
        # Save and process files
        payroll_filename = secure_filename(payroll_file.filename)
        dbase_filename = secure_filename(dbase_file.filename)
        
        payroll_path = os.path.join(app.config['UPLOAD_FOLDER'], payroll_filename)
        dbase_path = os.path.join(app.config['UPLOAD_FOLDER'], dbase_filename)
        
        payroll_file.save(payroll_path)
        dbase_file.save(dbase_path)
        
        # Read files - skip header rows for payroll file
        try:
            # Try to find the data start row by looking for "CCR" or numeric employee IDs
            payroll_df_temp = pd.read_excel(payroll_path, sheet_name=0, header=None)
            
            # Find the header row (look for "CCR CODE" or "ACCT NO" or numeric pattern)
            data_start_row = None
            for idx in range(min(20, len(payroll_df_temp))):
                row_vals = payroll_df_temp.iloc[idx].astype(str).str.upper()
                if any('CCR' in str(val) or 'ACCT' in str(val) or 'EMPLOYEE' in str(val) for val in row_vals):
                    data_start_row = idx + 1  # Data starts after header
                    break
            
            if data_start_row is None:
                # If no header found, look for first row with numeric employee ID
                for idx in range(min(20, len(payroll_df_temp))):
                    first_val = str(payroll_df_temp.iloc[idx, 0])
                    if first_val.isdigit() and len(first_val) == 6:  # Employee ID pattern
                        data_start_row = idx
                        break
            
            if data_start_row is None:
                data_start_row = 0
            
            print(f"Found data starting at row {data_start_row}")
            
            # Read again with correct starting row
            payroll_df = pd.read_excel(payroll_path, sheet_name=0, skiprows=data_start_row, header=None)
            
            # Check if first row still looks like headers, skip one more row
            first_row_str = ' '.join(str(v).upper() for v in payroll_df.iloc[0].tolist()[:5])
            if any(keyword in first_row_str for keyword in ['CCR', 'EMP', 'ACCT', 'NAME', 'SALARY', 'BASIC']):
                print(f"First row still has headers, skipping one more row")
                payroll_df = payroll_df.iloc[1:].reset_index(drop=True)
            
            print(f"Payroll file loaded: {len(payroll_df)} rows, {len(payroll_df.columns)} columns")
            print(f"First data row: {payroll_df.iloc[0].tolist()[:5]}")
            
        except Exception as e:
            return jsonify({'error': f'Error reading payroll file: {str(e)}'}), 400
        
        try:
            # Database file might also have headers
            dbase_df_temp = pd.read_excel(dbase_path, sheet_name=0, header=None)
            
            # Check if first row looks like headers
            first_row = dbase_df_temp.iloc[0].astype(str)
            if any(not str(val).isdigit() for val in first_row if pd.notna(val)):
                # Has headers, skip first row
                dbase_df = pd.read_excel(dbase_path, sheet_name=0, skiprows=1, header=None)
            else:
                dbase_df = dbase_df_temp
            
            print(f"Database file loaded: {len(dbase_df)} rows, {len(dbase_df.columns)} columns")
            print(f"First DB row: {dbase_df.iloc[0].tolist()[:5]}")
        except Exception as e:
            return jsonify({'error': f'Error reading database file: {str(e)}'}), 400
        
        # Validate minimum columns
        if len(payroll_df.columns) < 10:
            return jsonify({
                'error': f'Payroll file has insufficient columns. Expected at least 10 columns, found {len(payroll_df.columns)}'
            }), 400
        
        if len(dbase_df.columns) < 4:
            return jsonify({
                'error': f'Database file has insufficient columns. Expected at least 4 columns, found {len(dbase_df.columns)}'
            }), 400
        
        # Convert to BDO format
        try:
            converter = BDOConverter(payroll_df, dbase_df)
            result = converter.convert()
            bank_df = result['bank']
            cash_df = result['cash']
        except ValueError as ve:
            return jsonify({'error': str(ve)}), 400
        except Exception as e:
            return jsonify({'error': f'Conversion error: {str(e)}'}), 500
        
        if len(bank_df) == 0 and len(cash_df) == 0:
            return jsonify({'error': 'No valid employee records found after conversion'}), 400
        
        # Save result with enhanced formatting
        output_filename = f"BDO_Payroll_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        output_path = os.path.join(app.config['UPLOAD_FOLDER'], output_filename)
        
        # Create workbook with multiple sheets
        wb = openpyxl.Workbook()
        
        # Remove default sheet
        if 'Sheet' in wb.sheetnames:
            wb.remove(wb['Sheet'])
        
        # ===== SHEET 1: SUMMARY =====
        ws_summary = wb.create_sheet("Summary")
        
        ws_summary.merge_cells('A1:D1')
        ws_summary['A1'] = "BANCO DE ORO (BDO) PAYROLL SUMMARY"
        ws_summary['A1'].font = Font(name='Arial', size=14, bold=True, color='0033A0')
        ws_summary['A1'].alignment = Alignment(horizontal='center', vertical='center')
        ws_summary.row_dimensions[1].height = 30
        
        ws_summary.merge_cells('A2:D2')
        ws_summary['A2'] = COMPANY_NAME
        ws_summary['A2'].font = Font(name='Arial', size=11, bold=True)
        ws_summary['A2'].alignment = Alignment(horizontal='center', vertical='center')
        
        ws_summary.merge_cells('A3:D3')
        ws_summary['A3'] = f"Generated: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}"
        ws_summary['A3'].font = Font(name='Arial', size=9, italic=True)
        ws_summary['A3'].alignment = Alignment(horizontal='center', vertical='center')
        
        ws_summary.row_dimensions[5].height = 15
        
        # Summary table
        summary_data = [
            ['Payment Type', 'Employee Count', 'Total Amount', 'Percentage'],
            ['BDO Bank Payroll', result['bank_count'], result['bank_total'], (result['bank_total']/result['total']*100) if result['total'] > 0 else 0],
            ['Cash Payroll', result['cash_count'], result['cash_total'], (result['cash_total']/result['total']*100) if result['total'] > 0 else 0],
            ['TOTAL PAYROLL', result['bank_count'] + result['cash_count'], result['total'], 100]
        ]
        
        for row_idx, row_data in enumerate(summary_data, start=6):
            for col_idx, value in enumerate(row_data, start=1):
                cell = ws_summary.cell(row=row_idx, column=col_idx, value=value)
                
                if row_idx == 6:  # Header
                    cell.font = Font(name='Arial', size=10, bold=True, color='FFFFFF')
                    cell.fill = PatternFill(start_color='0033A0', end_color='0033A0', fill_type='solid')
                    cell.alignment = Alignment(horizontal='center', vertical='center')
                elif row_idx == 9:  # Total
                    cell.font = Font(name='Arial', size=11, bold=True, color='C00000')
                    cell.fill = PatternFill(start_color='FFE699', end_color='FFE699', fill_type='solid')
                else:
                    cell.font = Font(name='Arial', size=10)
                
                # Number formatting
                if col_idx == 3 and row_idx > 6:
                    cell.number_format = 'â‚±#,##0.00'
                elif col_idx == 4 and row_idx > 6:
                    cell.number_format = '0.00%'
                    if isinstance(value, (int, float)):
                        cell.value = value / 100
                
                # Borders
                cell.border = Border(
                    left=Side(style='thin'), right=Side(style='thin'),
                    top=Side(style='thin'), bottom=Side(style='thin')
                )
                
                # Alignment
                if col_idx in [2, 3, 4]:
                    cell.alignment = Alignment(horizontal='right', vertical='center')
        
        ws_summary.column_dimensions['A'].width = 20
        ws_summary.column_dimensions['B'].width = 18
        ws_summary.column_dimensions['C'].width = 18
        ws_summary.column_dimensions['D'].width = 15
        
        # ===== SHEET 2: BDO BANK PAYROLL =====
        if len(bank_df) > 0:
            create_bdo_sheet(wb, "BDO Bank Payroll", bank_df, result['bank_count'], result['bank_total'])
        
        # ===== SHEET 3: CASH PAYROLL =====
        if len(cash_df) > 0:
            create_cash_sheet(wb, "Cash Payroll", cash_df, result['cash_count'], result['cash_total'])
        
        wb.save(output_path)
        
        return jsonify({
            'success': True,
            'message': f'BDO conversion completed - {result["bank_count"]} bank, {result["cash_count"]} cash',
            'download_url': f'/download/{output_filename}',
            'summary': {
                'bank_employees': result['bank_count'],
                'cash_employees': result['cash_count'],
                'bank_amount': f'â‚±{result["bank_total"]:,.2f}',
                'cash_amount': f'â‚±{result["cash_total"]:,.2f}',
                'total_amount': f'â‚±{result["total"]:,.2f}'
            }
        })
        
        # ===== HEADER SECTION =====
        # Row 1: Bank name and report title
        ws.merge_cells('A1:E1')
        ws['A1'] = "BANCO DE ORO (BDO) UNIBANK, INC."
        ws['A1'].font = Font(name='Arial', size=14, bold=True, color='0033A0')
        ws['A1'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[1].height = 25
        
        # Row 2: Report type
        ws.merge_cells('A2:E2')
        ws['A2'] = "Payroll Crediting File"
        ws['A2'].font = Font(name='Arial', size=12, bold=True)
        ws['A2'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[2].height = 22
        
        # Row 3: Company info
        ws.merge_cells('A3:E3')
        ws['A3'] = COMPANY_NAME
        ws['A3'].font = Font(name='Arial', size=11, bold=True)
        ws['A3'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[3].height = 20
        
        # Row 4: Date and time
        ws.merge_cells('A4:E4')
        ws['A4'] = f"Generated: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}"
        ws['A4'].font = Font(name='Arial', size=9, italic=True)
        ws['A4'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[4].height = 18
        
        # Row 5: Spacing
        ws.row_dimensions[5].height = 10
        
        # Row 6: Summary information
        total_amount = result_df['Net Pay'].sum()
        total_employees = len(result_df)
        
        ws['A6'] = "Total Employees:"
        ws['A6'].font = Font(name='Arial', size=10, bold=True)
        ws['B6'] = total_employees
        ws['B6'].font = Font(name='Arial', size=10)
        ws['B6'].alignment = Alignment(horizontal='left')
        
        ws['D6'] = "Total Amount:"
        ws['D6'].font = Font(name='Arial', size=10, bold=True)
        ws['D6'].alignment = Alignment(horizontal='right')
        ws['E6'] = total_amount
        ws['E6'].font = Font(name='Arial', size=10, bold=True, color='006100')
        ws['E6'].number_format = 'â‚±#,##0.00'
        ws['E6'].alignment = Alignment(horizontal='right')
        
        ws.row_dimensions[6].height = 20
        
        # Row 7: Spacing
        ws.row_dimensions[7].height = 8
        
        # ===== COLUMN HEADERS (Row 8) =====
        headers = ['Account Number', 'Net Pay Amount', 'Employee Name', 'Status', 'Remarks']
        header_colors = ['4472C4', '4472C4', '4472C4', '70AD47', 'ED7D31']
        
        for col_idx, (header, color) in enumerate(zip(headers, header_colors), start=1):
            cell = ws.cell(row=8, column=col_idx, value=header)
            cell.font = Font(name='Arial', size=10, bold=True, color='FFFFFF')
            cell.fill = PatternFill(start_color=color, end_color=color, fill_type='solid')
            cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
            cell.border = Border(
                left=Side(style='medium', color='000000'),
                right=Side(style='medium', color='000000'),
                top=Side(style='medium', color='000000'),
                bottom=Side(style='medium', color='000000')
            )
        
        ws.row_dimensions[8].height = 35
        
        # ===== DATA ROWS =====
        for row_idx, row_data in enumerate(result_df.itertuples(index=False), start=9):
            # Alternating row colors for better readability
            if row_idx % 2 == 0:
                row_fill = PatternFill(start_color='F2F2F2', end_color='F2F2F2', fill_type='solid')
            else:
                row_fill = PatternFill(start_color='FFFFFF', end_color='FFFFFF', fill_type='solid')
            
            # Account Number
            cell = ws.cell(row=row_idx, column=1, value=row_data[0])
            cell.font = Font(name='Courier New', size=10, bold=True)
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.fill = row_fill
            
            # Net Pay Amount
            cell = ws.cell(row=row_idx, column=2, value=row_data[1])
            cell.font = Font(name='Arial', size=10, bold=True)
            cell.number_format = 'â‚±#,##0.00'
            cell.alignment = Alignment(horizontal='right', vertical='center')
            cell.fill = row_fill
            
            # Employee Name
            cell = ws.cell(row=row_idx, column=3, value=row_data[2])
            cell.font = Font(name='Arial', size=10)
            cell.alignment = Alignment(horizontal='left', vertical='center')
            cell.fill = row_fill
            
            # Status (all "Ready")
            cell = ws.cell(row=row_idx, column=4, value="Ready")
            cell.font = Font(name='Arial', size=9, bold=True, color='006100')
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.fill = row_fill
            
            # Remarks (empty)
            cell = ws.cell(row=row_idx, column=5, value="")
            cell.fill = row_fill
            
            # Apply borders to all cells in row
            for col_idx in range(1, 6):
                ws.cell(row=row_idx, column=col_idx).border = Border(
                    left=Side(style='thin', color='CCCCCC'),
                    right=Side(style='thin', color='CCCCCC'),
                    top=Side(style='thin', color='CCCCCC'),
                    bottom=Side(style='thin', color='CCCCCC')
                )
            
            ws.row_dimensions[row_idx].height = 22
        
        # ===== FOOTER SECTION =====
        footer_row = len(result_df) + 9
        
        # Add spacing
        ws.row_dimensions[footer_row].height = 15
        footer_row += 1
        
        # Total row with bold styling
        ws.merge_cells(f'A{footer_row}:A{footer_row}')
        ws[f'A{footer_row}'] = "TOTAL:"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=11, bold=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='right', vertical='center')
        ws[f'A{footer_row}'].fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
        
        ws[f'B{footer_row}'] = f'=SUM(B9:B{footer_row-2})'
        ws[f'B{footer_row}'].font = Font(name='Arial', size=11, bold=True, color='C00000')
        ws[f'B{footer_row}'].number_format = 'â‚±#,##0.00'
        ws[f'B{footer_row}'].alignment = Alignment(horizontal='right', vertical='center')
        ws[f'B{footer_row}'].fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
        
        ws.merge_cells(f'C{footer_row}:E{footer_row}')
        ws[f'C{footer_row}'] = f"{total_employees} Employees"
        ws[f'C{footer_row}'].font = Font(name='Arial', size=10, bold=True)
        ws[f'C{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        ws[f'C{footer_row}'].fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
        
        # Apply thick border to total row
        for col_idx in range(1, 6):
            ws.cell(row=footer_row, column=col_idx).border = Border(
                left=Side(style='medium', color='000000'),
                right=Side(style='medium', color='000000'),
                top=Side(style='double', color='000000'),
                bottom=Side(style='double', color='000000')
            )
        
        ws.row_dimensions[footer_row].height = 28
        
        # Add certification section
        footer_row += 3
        ws.merge_cells(f'A{footer_row}:E{footer_row}')
        ws[f'A{footer_row}'] = "CERTIFICATION"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=11, bold=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[footer_row].height = 20
        
        footer_row += 1
        ws.merge_cells(f'A{footer_row}:E{footer_row}')
        cert_text = "This is to certify that the above information is true and correct. All account numbers have been verified and amounts are accurate."
        ws[f'A{footer_row}'] = cert_text
        ws[f'A{footer_row}'].font = Font(name='Arial', size=9, italic=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
        ws.row_dimensions[footer_row].height = 30
        
        # Signature section
        footer_row += 3
        
        # Prepared by
        ws.merge_cells(f'A{footer_row}:B{footer_row}')
        ws[f'A{footer_row}'] = "Prepared by:"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=9, bold=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='left', vertical='center')
        
        footer_row += 2
        ws.merge_cells(f'A{footer_row}:B{footer_row}')
        ws[f'A{footer_row}'] = "_" * 35
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        footer_row += 1
        ws.merge_cells(f'A{footer_row}:B{footer_row}')
        ws[f'A{footer_row}'] = "RACQUEL CABRAL"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=10, bold=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        footer_row += 1
        ws.merge_cells(f'A{footer_row}:B{footer_row}')
        ws[f'A{footer_row}'] = "HR Manager"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=9)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        # Approved by (right side)
        footer_row -= 4
        ws.merge_cells(f'D{footer_row}:E{footer_row}')
        ws[f'D{footer_row}'] = "Approved by:"
        ws[f'D{footer_row}'].font = Font(name='Arial', size=9, bold=True)
        ws[f'D{footer_row}'].alignment = Alignment(horizontal='left', vertical='center')
        
        footer_row += 2
        ws.merge_cells(f'D{footer_row}:E{footer_row}')
        ws[f'D{footer_row}'] = "_" * 35
        ws[f'D{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        footer_row += 1
        ws.merge_cells(f'D{footer_row}:E{footer_row}')
        ws[f'D{footer_row}'] = "YEN-PAN HSUEH"
        ws[f'D{footer_row}'].font = Font(name='Arial', size=10, bold=True)
        ws[f'D{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        footer_row += 1
        ws.merge_cells(f'D{footer_row}:E{footer_row}')
        ws[f'D{footer_row}'] = "Director"
        ws[f'D{footer_row}'].font = Font(name='Arial', size=9)
        ws[f'D{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        # ===== COLUMN WIDTHS =====
        ws.column_dimensions['A'].width = 18
        ws.column_dimensions['B'].width = 16
        ws.column_dimensions['C'].width = 35
        ws.column_dimensions['D'].width = 12
        ws.column_dimensions['E'].width = 20
        
        # ===== FREEZE PANES & PRINT SETTINGS =====
        ws.freeze_panes = 'A9'
        
        # Print settings
        ws.page_setup.orientation = ws.ORIENTATION_PORTRAIT
        ws.page_setup.paperSize = ws.PAPERSIZE_LETTER
        ws.page_setup.fitToWidth = 1
        ws.page_setup.fitToHeight = 0
        
        # Page margins
        from openpyxl.worksheet.page import PageMargins
        ws.page_margins = PageMargins(left=0.5, right=0.5, top=0.75, bottom=0.75, header=0.3, footer=0.3)
        
        # Repeat header row on each page
        ws.print_title_rows = '1:8'
        
        # Auto-filter on data
        ws.auto_filter.ref = f"A8:E{len(result_df) + 8}"
        
        wb.save(output_path)
        
        return jsonify({
            'success': True,
            'message': f'BDO conversion completed successfully - {total_employees} employees processed',
            'download_url': f'/download/{output_filename}',
            'summary': {
                'total_employees': total_employees,
                'total_amount': f'â‚±{total_amount:,.2f}'
            }
        })
        
    except Exception as e:
        print(f"Error in convert_bdo: {traceback.format_exc()}")
        return jsonify({'error': f'Unexpected error: {str(e)}'}), 500
def convert_bdo():
    """Convert to BDO format"""
    try:
        if 'payroll_file' not in request.files or 'dbase_file' not in request.files:
            return jsonify({'error': 'Missing required files'}), 400
        
        payroll_file = request.files['payroll_file']
        dbase_file = request.files['dbase_file']
        
        # Save and process files
        payroll_filename = secure_filename(payroll_file.filename)
        dbase_filename = secure_filename(dbase_file.filename)
        
        payroll_path = os.path.join(app.config['UPLOAD_FOLDER'], payroll_filename)
        dbase_path = os.path.join(app.config['UPLOAD_FOLDER'], dbase_filename)
        
        payroll_file.save(payroll_path)
        dbase_file.save(dbase_path)
        
        # Read files with proper error handling
        try:
            payroll_df = pd.read_excel(payroll_path, sheet_name=0)
            print(f"Payroll file loaded: {len(payroll_df)} rows, {len(payroll_df.columns)} columns")
        except Exception as e:
            return jsonify({'error': f'Error reading payroll file: {str(e)}'}), 400
        
        try:
            dbase_df = pd.read_excel(dbase_path, sheet_name=0)
            print(f"Database file loaded: {len(dbase_df)} rows, {len(dbase_df.columns)} columns")
        except Exception as e:
            return jsonify({'error': f'Error reading database file: {str(e)}'}), 400
        
        # Validate minimum columns
        if len(payroll_df.columns) < 33:
            return jsonify({
                'error': f'Payroll file has insufficient columns. Expected at least 33 columns, found {len(payroll_df.columns)}'
            }), 400
        
        if len(dbase_df.columns) < 4:
            return jsonify({
                'error': f'Database file has insufficient columns. Expected at least 4 columns, found {len(dbase_df.columns)}'
            }), 400
        
        # Convert to BDO format
        try:
            converter = BDOConverter(payroll_df, dbase_df)
            result_df = converter.convert()
        except ValueError as ve:
            return jsonify({'error': str(ve)}), 400
        except Exception as e:
            return jsonify({'error': f'Conversion error: {str(e)}'}), 500
        
        if len(result_df) == 0:
            return jsonify({'error': 'No valid employee records found after conversion'}), 400
        
        # Save result with enhanced formatting
        output_filename = f"BDO_Payroll_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        output_path = os.path.join(app.config['UPLOAD_FOLDER'], output_filename)
        
        # Create professionally formatted BDO Excel
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "BDO Payroll Upload"
        
        # ===== HEADER SECTION =====
        # Row 1: Bank name and report title
        ws.merge_cells('A1:E1')
        ws['A1'] = "BANCO DE ORO (BDO) UNIBANK, INC."
        ws['A1'].font = Font(name='Arial', size=14, bold=True, color='0033A0')
        ws['A1'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[1].height = 25
        
        # Row 2: Report type
        ws.merge_cells('A2:E2')
        ws['A2'] = "Payroll Crediting File"
        ws['A2'].font = Font(name='Arial', size=12, bold=True)
        ws['A2'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[2].height = 22
        
        # Row 3: Company info
        ws.merge_cells('A3:E3')
        ws['A3'] = COMPANY_NAME
        ws['A3'].font = Font(name='Arial', size=11, bold=True)
        ws['A3'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[3].height = 20
        
        # Row 4: Date and time
        ws.merge_cells('A4:E4')
        ws['A4'] = f"Generated: {datetime.now().strftime('%B %d, %Y at %I:%M %p')}"
        ws['A4'].font = Font(name='Arial', size=9, italic=True)
        ws['A4'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[4].height = 18
        
        # Row 5: Spacing
        ws.row_dimensions[5].height = 10
        
        # Row 6: Summary information
        total_amount = result_df['Net Pay'].sum()
        total_employees = len(result_df)
        
        ws['A6'] = "Total Employees:"
        ws['A6'].font = Font(name='Arial', size=10, bold=True)
        ws['B6'] = total_employees
        ws['B6'].font = Font(name='Arial', size=10)
        ws['B6'].alignment = Alignment(horizontal='left')
        
        ws['D6'] = "Total Amount:"
        ws['D6'].font = Font(name='Arial', size=10, bold=True)
        ws['D6'].alignment = Alignment(horizontal='right')
        ws['E6'] = total_amount
        ws['E6'].font = Font(name='Arial', size=10, bold=True, color='006100')
        ws['E6'].number_format = 'â‚±#,##0.00'
        ws['E6'].alignment = Alignment(horizontal='right')
        
        ws.row_dimensions[6].height = 20
        
        # Row 7: Spacing
        ws.row_dimensions[7].height = 8
        
        # ===== COLUMN HEADERS (Row 8) =====
        headers = ['Account Number', 'Net Pay Amount', 'Employee Name', 'Status', 'Remarks']
        header_colors = ['4472C4', '4472C4', '4472C4', '70AD47', 'ED7D31']
        
        for col_idx, (header, color) in enumerate(zip(headers, header_colors), start=1):
            cell = ws.cell(row=8, column=col_idx, value=header)
            cell.font = Font(name='Arial', size=10, bold=True, color='FFFFFF')
            cell.fill = PatternFill(start_color=color, end_color=color, fill_type='solid')
            cell.alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
            cell.border = Border(
                left=Side(style='medium', color='000000'),
                right=Side(style='medium', color='000000'),
                top=Side(style='medium', color='000000'),
                bottom=Side(style='medium', color='000000')
            )
        
        ws.row_dimensions[8].height = 35
        
        # ===== DATA ROWS =====
        for row_idx, row_data in enumerate(result_df.itertuples(index=False), start=9):
            # Alternating row colors for better readability
            if row_idx % 2 == 0:
                row_fill = PatternFill(start_color='F2F2F2', end_color='F2F2F2', fill_type='solid')
            else:
                row_fill = PatternFill(start_color='FFFFFF', end_color='FFFFFF', fill_type='solid')
            
            # Account Number
            cell = ws.cell(row=row_idx, column=1, value=row_data[0])
            cell.font = Font(name='Courier New', size=10, bold=True)
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.fill = row_fill
            
            # Net Pay Amount
            cell = ws.cell(row=row_idx, column=2, value=row_data[1])
            cell.font = Font(name='Arial', size=10, bold=True)
            cell.number_format = 'â‚±#,##0.00'
            cell.alignment = Alignment(horizontal='right', vertical='center')
            cell.fill = row_fill
            
            # Employee Name
            cell = ws.cell(row=row_idx, column=3, value=row_data[2])
            cell.font = Font(name='Arial', size=10)
            cell.alignment = Alignment(horizontal='left', vertical='center')
            cell.fill = row_fill
            
            # Status (all "Ready")
            cell = ws.cell(row=row_idx, column=4, value="Ready")
            cell.font = Font(name='Arial', size=9, bold=True, color='006100')
            cell.alignment = Alignment(horizontal='center', vertical='center')
            cell.fill = row_fill
            
            # Remarks (empty)
            cell = ws.cell(row=row_idx, column=5, value="")
            cell.fill = row_fill
            
            # Apply borders to all cells in row
            for col_idx in range(1, 6):
                ws.cell(row=row_idx, column=col_idx).border = Border(
                    left=Side(style='thin', color='CCCCCC'),
                    right=Side(style='thin', color='CCCCCC'),
                    top=Side(style='thin', color='CCCCCC'),
                    bottom=Side(style='thin', color='CCCCCC')
                )
            
            ws.row_dimensions[row_idx].height = 22
        
        # ===== FOOTER SECTION =====
        footer_row = len(result_df) + 9
        
        # Add spacing
        ws.row_dimensions[footer_row].height = 15
        footer_row += 1
        
        # Total row with bold styling
        ws.merge_cells(f'A{footer_row}:A{footer_row}')
        ws[f'A{footer_row}'] = "TOTAL:"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=11, bold=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='right', vertical='center')
        ws[f'A{footer_row}'].fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
        
        ws[f'B{footer_row}'] = f'=SUM(B9:B{footer_row-2})'
        ws[f'B{footer_row}'].font = Font(name='Arial', size=11, bold=True, color='C00000')
        ws[f'B{footer_row}'].number_format = 'â‚±#,##0.00'
        ws[f'B{footer_row}'].alignment = Alignment(horizontal='right', vertical='center')
        ws[f'B{footer_row}'].fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
        
        ws.merge_cells(f'C{footer_row}:E{footer_row}')
        ws[f'C{footer_row}'] = f"{total_employees} Employees"
        ws[f'C{footer_row}'].font = Font(name='Arial', size=10, bold=True)
        ws[f'C{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        ws[f'C{footer_row}'].fill = PatternFill(start_color='D9E1F2', end_color='D9E1F2', fill_type='solid')
        
        # Apply thick border to total row
        for col_idx in range(1, 6):
            ws.cell(row=footer_row, column=col_idx).border = Border(
                left=Side(style='medium', color='000000'),
                right=Side(style='medium', color='000000'),
                top=Side(style='double', color='000000'),
                bottom=Side(style='double', color='000000')
            )
        
        ws.row_dimensions[footer_row].height = 28
        
        # Add certification section
        footer_row += 3
        ws.merge_cells(f'A{footer_row}:E{footer_row}')
        ws[f'A{footer_row}'] = "CERTIFICATION"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=11, bold=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        ws.row_dimensions[footer_row].height = 20
        
        footer_row += 1
        ws.merge_cells(f'A{footer_row}:E{footer_row}')
        cert_text = "This is to certify that the above information is true and correct. All account numbers have been verified and amounts are accurate."
        ws[f'A{footer_row}'] = cert_text
        ws[f'A{footer_row}'].font = Font(name='Arial', size=9, italic=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center', wrap_text=True)
        ws.row_dimensions[footer_row].height = 30
        
        # Signature section
        footer_row += 3
        
        # Prepared by
        ws.merge_cells(f'A{footer_row}:B{footer_row}')
        ws[f'A{footer_row}'] = "Prepared by:"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=9, bold=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='left', vertical='center')
        
        footer_row += 2
        ws.merge_cells(f'A{footer_row}:B{footer_row}')
        ws[f'A{footer_row}'] = "_" * 35
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        footer_row += 1
        ws.merge_cells(f'A{footer_row}:B{footer_row}')
        ws[f'A{footer_row}'] = "RACQUEL CABRAL"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=10, bold=True)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        footer_row += 1
        ws.merge_cells(f'A{footer_row}:B{footer_row}')
        ws[f'A{footer_row}'] = "HR Manager"
        ws[f'A{footer_row}'].font = Font(name='Arial', size=9)
        ws[f'A{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        # Approved by (right side)
        footer_row -= 4
        ws.merge_cells(f'D{footer_row}:E{footer_row}')
        ws[f'D{footer_row}'] = "Approved by:"
        ws[f'D{footer_row}'].font = Font(name='Arial', size=9, bold=True)
        ws[f'D{footer_row}'].alignment = Alignment(horizontal='left', vertical='center')
        
        footer_row += 2
        ws.merge_cells(f'D{footer_row}:E{footer_row}')
        ws[f'D{footer_row}'] = "_" * 35
        ws[f'D{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        footer_row += 1
        ws.merge_cells(f'D{footer_row}:E{footer_row}')
        ws[f'D{footer_row}'] = "YEN-PAN HSUEH"
        ws[f'D{footer_row}'].font = Font(name='Arial', size=10, bold=True)
        ws[f'D{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        footer_row += 1
        ws.merge_cells(f'D{footer_row}:E{footer_row}')
        ws[f'D{footer_row}'] = "Director"
        ws[f'D{footer_row}'].font = Font(name='Arial', size=9)
        ws[f'D{footer_row}'].alignment = Alignment(horizontal='center', vertical='center')
        
        # ===== COLUMN WIDTHS =====
        ws.column_dimensions['A'].width = 18
        ws.column_dimensions['B'].width = 16
        ws.column_dimensions['C'].width = 35
        ws.column_dimensions['D'].width = 12
        ws.column_dimensions['E'].width = 20
        
        # ===== FREEZE PANES & PRINT SETTINGS =====
        ws.freeze_panes = 'A9'
        
        # Print settings
        ws.page_setup.orientation = ws.ORIENTATION_PORTRAIT
        ws.page_setup.paperSize = ws.PAPERSIZE_LETTER
        ws.page_setup.fitToWidth = 1
        ws.page_setup.fitToHeight = 0
        
        # Page margins
        from openpyxl.worksheet.page import PageMargins
        ws.page_margins = PageMargins(left=0.5, right=0.5, top=0.75, bottom=0.75, header=0.3, footer=0.3)
        
        # Repeat header row on each page
        ws.print_title_rows = '1:8'
        
        # Auto-filter on data
        ws.auto_filter.ref = f"A8:E{len(result_df) + 8}"
        
        wb.save(output_path)
        
        return jsonify({
            'success': True,
            'message': f'BDO conversion completed successfully - {total_employees} employees processed',
            'download_url': f'/download/{output_filename}',
            'summary': {
                'total_employees': total_employees,
                'total_amount': f'â‚±{total_amount:,.2f}'
            }
        })
        
    except Exception as e:
        print(f"Error in convert_bdo: {traceback.format_exc()}")
        return jsonify({'error': f'Unexpected error: {str(e)}'}), 500
def convert_bdo():
    """Convert to BDO format"""
    try:
        if 'payroll_file' not in request.files or 'dbase_file' not in request.files:
            return jsonify({'error': 'Missing required files'}), 400
        
        payroll_file = request.files['payroll_file']
        dbase_file = request.files['dbase_file']
        
        # Save and process files
        payroll_filename = secure_filename(payroll_file.filename)
        dbase_filename = secure_filename(dbase_file.filename)
        
        payroll_path = os.path.join(app.config['UPLOAD_FOLDER'], payroll_filename)
        dbase_path = os.path.join(app.config['UPLOAD_FOLDER'], dbase_filename)
        
        payroll_file.save(payroll_path)
        dbase_file.save(dbase_path)
        
        payroll_df = pd.read_excel(payroll_path)
        dbase_df = pd.read_excel(dbase_path)
        
        # Convert to BDO format
        converter = BDOConverter(payroll_df, dbase_df)
        result_df = converter.convert()
        
        # Save result with enhanced formatting
        output_filename = f"BDO_Payroll_{datetime.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
        output_path = os.path.join(app.config['UPLOAD_FOLDER'], output_filename)
        
        # Create formatted Excel for BDO
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "BDO Converter"
        
        # Write headers with formatting
        headers = ['Account No.', 'Net Pay', 'Name']
        for col_idx, header in enumerate(headers, start=1):
            cell = ws.cell(row=1, column=col_idx, value=header)
            cell.font = Font(name='Arial', size=11, bold=True)
            cell.fill = PatternFill(start_color='4472C4', end_color='4472C4', fill_type='solid')
            cell.font = Font(name='Arial', size=11, bold=True, color='FFFFFF')
            cell.alignment = Alignment(horizontal='center', vertical='center')
        
        # Write data
        for row_idx, row_data in enumerate(result_df.itertuples(index=False), start=2):
            for col_idx, value in enumerate(row_data, start=1):
                cell = ws.cell(row=row_idx, column=col_idx, value=value)
                cell.font = Font(name='Arial', size=10)
                
                # Format Net Pay column as currency
                if col_idx == 2:
                    cell.number_format = '#,##0.00'
                    cell.alignment = Alignment(horizontal='right')
        
        # Set column widths
        ws.column_dimensions['A'].width = 15
        ws.column_dimensions['B'].width = 15
        ws.column_dimensions['C'].width = 35
        
        # Apply borders
        thin_border = Border(
            left=Side(style='thin', color='000000'),
            right=Side(style='thin', color='000000'),
            top=Side(style='thin', color='000000'),
            bottom=Side(style='thin', color='000000')
        )
        
        for row in ws.iter_rows(min_row=1, max_row=ws.max_row, min_col=1, max_col=3):
            for cell in row:
                cell.border = thin_border
        
        # Freeze header row
        ws.freeze_panes = 'A2'
        
        # Auto-filter
        ws.auto_filter.ref = f"A1:C{ws.max_row}"
        
        wb.save(output_path)
        
        return jsonify({
            'success': True,
            'message': 'BDO conversion completed',
            'download_url': f'/download/{output_filename}'
        })
        
    except Exception as e:
        print(f"Error in convert_bdo: {traceback.format_exc()}")
        return jsonify({'error': str(e)}), 500

@app.route('/download/<filename>')
def download_file(filename):
    """Download processed file"""
    try:
        file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        return send_file(file_path, as_attachment=True)
    except Exception as e:
        return jsonify({'error': str(e)}), 404

@app.errorhandler(413)
def too_large(e):
    return jsonify({'error': 'File is too large. Maximum size is 16MB'}), 413

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)